<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html"><link rel="search" title="Search" href="../../../search.html">

    <!-- Generated with Sphinx 9.1.0 and Furo 2025.12.19 -->
        <title>ray._private.worker - deisa-ray documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">deisa-ray  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <span class="sidebar-brand-text">deisa-ray  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../analytics.html">Analytics</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for ray._private.worker</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">atexit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">faulthandler</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AnyStr</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generic</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Protocol</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">overload</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">colorama</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ray</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray._private.node</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray._private.parameter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray._private.profiling</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">profiling</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray._private.ray_constants</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ray_constants</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray._private.serialization</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">serialization</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray._private.services</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">services</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray._private.state</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray._private.worker</span>

<span class="c1"># Ray modules</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray.actor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray.cloudpickle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pickle</span>  <span class="c1"># noqa</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray.job_config</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ray.remote_function</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActorID</span><span class="p">,</span> <span class="n">JobID</span><span class="p">,</span> <span class="n">Language</span><span class="p">,</span> <span class="n">ObjectRef</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._common.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_class</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private</span><span class="w"> </span><span class="kn">import</span> <span class="n">ray_option_utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.client_mode_hook</span><span class="w"> </span><span class="kn">import</span> <span class="n">client_mode_hook</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.function_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FunctionActorManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.inspect_util</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_cython</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.ray_logging</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">global_worker_stdstream_dispatcher</span><span class="p">,</span>
    <span class="n">setup_logger</span><span class="p">,</span>
    <span class="n">stderr_deduplicator</span><span class="p">,</span>
    <span class="n">stdout_deduplicator</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.ray_logging.logging_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggingConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.resource_isolation_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResourceIsolationConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.runtime_env.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">RAY_JOB_CONFIG_JSON_ENV_VAR</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.runtime_env.py_modules</span><span class="w"> </span><span class="kn">import</span> <span class="n">upload_py_modules_if_needed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.runtime_env.setup_hook</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">upload_worker_process_setup_hook_if_needed</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.runtime_env.working_dir</span><span class="w"> </span><span class="kn">import</span> <span class="n">upload_working_dir_if_needed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_ray_doc_version</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray._raylet</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ObjectRefGenerator</span><span class="p">,</span>
    <span class="n">TaskID</span><span class="p">,</span>
    <span class="n">raise_sys_exit_with_custom_error_message</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.actor</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActorClass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectStoreFullError</span><span class="p">,</span> <span class="n">RayError</span><span class="p">,</span> <span class="n">RaySystemError</span><span class="p">,</span> <span class="n">RayTaskError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.experimental</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm_ray</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.experimental.compiled_dag_ref</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompiledDAGRef</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.experimental.internal_kv</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">_initialize_internal_kv</span><span class="p">,</span>
    <span class="n">_internal_kv_get</span><span class="p">,</span>
    <span class="n">_internal_kv_initialized</span><span class="p">,</span>
    <span class="n">_internal_kv_reset</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.experimental.tqdm_ray</span><span class="w"> </span><span class="kn">import</span> <span class="n">RAY_TQDM_MAGIC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.runtime_env.runtime_env</span><span class="w"> </span><span class="kn">import</span> <span class="n">_merge_runtime_env</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.util.annotations</span><span class="w"> </span><span class="kn">import</span> <span class="n">Deprecated</span><span class="p">,</span> <span class="n">DeveloperAPI</span><span class="p">,</span> <span class="n">PublicAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.util.debug</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_once</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.util.scheduling_strategies</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlacementGroupSchedulingStrategy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.util.tracing.tracing_helper</span><span class="w"> </span><span class="kn">import</span> <span class="n">_import_from_string</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.widgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ray.widgets.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">repr_with_fallback</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">SCRIPT_MODE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">WORKER_MODE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">LOCAL_MODE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">SPILL_WORKER_MODE</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">RESTORE_WORKER_MODE</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1"># Logger for this module. It should be configured at the entry point</span>
<span class="c1"># into the program using Ray. Ray provides a default configuration at</span>
<span class="c1"># entry/init points.</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T0&quot;</span><span class="p">)</span>
<span class="n">T1</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T1&quot;</span><span class="p">)</span>
<span class="n">T2</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T2&quot;</span><span class="p">)</span>
<span class="n">T3</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T3&quot;</span><span class="p">)</span>
<span class="n">T4</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T4&quot;</span><span class="p">)</span>
<span class="n">T5</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T5&quot;</span><span class="p">)</span>
<span class="n">T6</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T6&quot;</span><span class="p">)</span>
<span class="n">T7</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T7&quot;</span><span class="p">)</span>
<span class="n">T8</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T8&quot;</span><span class="p">)</span>
<span class="n">T9</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T9&quot;</span><span class="p">)</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">)</span>

<span class="n">DAGNode</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;DAGNode&quot;</span><span class="p">)</span>


<span class="c1"># Only used for type annotations as a placeholder</span>
<span class="n">Undefined</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<span class="c1"># TypeVar for self-referential generics in `RemoteFunction[N]`.</span>
<span class="n">RF</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;RF&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;HasOptions&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">HasOptions</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">RF</span><span class="p">,</span> <span class="o">**</span><span class="n">task_options</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RF</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteFunctionNoArgs</span><span class="p">(</span><span class="n">HasOptions</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DAGNode[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteFunction0</span><span class="p">(</span><span class="n">HasOptions</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, ObjectRef[T0]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, DAGNode[T0]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DAGNode[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteFunction1</span><span class="p">(</span><span class="n">HasOptions</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, ObjectRef[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, ObjectRef[T1]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, DAGNode[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, DAGNode[T1]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DAGNode[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteFunction2</span><span class="p">(</span><span class="n">HasOptions</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, ObjectRef[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, ObjectRef[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, ObjectRef[T2]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, DAGNode[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, DAGNode[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, DAGNode[T2]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DAGNode[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteFunction3</span><span class="p">(</span><span class="n">HasOptions</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, ObjectRef[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, ObjectRef[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, ObjectRef[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, ObjectRef[T3]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, DAGNode[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, DAGNode[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, DAGNode[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, DAGNode[T3]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DAGNode[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteFunction4</span><span class="p">(</span><span class="n">HasOptions</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, ObjectRef[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, ObjectRef[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, ObjectRef[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, ObjectRef[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, ObjectRef[T4]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, DAGNode[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, DAGNode[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, DAGNode[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, DAGNode[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, DAGNode[T4]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DAGNode[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteFunction5</span><span class="p">(</span><span class="n">HasOptions</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, ObjectRef[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, ObjectRef[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, ObjectRef[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, ObjectRef[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, ObjectRef[T4]]&quot;</span><span class="p">,</span>
        <span class="n">__arg5</span><span class="p">:</span> <span class="s2">&quot;Union[T5, ObjectRef[T5]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, DAGNode[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, DAGNode[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, DAGNode[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, DAGNode[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, DAGNode[T4]]&quot;</span><span class="p">,</span>
        <span class="n">__arg5</span><span class="p">:</span> <span class="s2">&quot;Union[T5, DAGNode[T5]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DAGNode[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteFunction6</span><span class="p">(</span><span class="n">HasOptions</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, ObjectRef[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, ObjectRef[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, ObjectRef[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, ObjectRef[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, ObjectRef[T4]]&quot;</span><span class="p">,</span>
        <span class="n">__arg5</span><span class="p">:</span> <span class="s2">&quot;Union[T5, ObjectRef[T5]]&quot;</span><span class="p">,</span>
        <span class="n">__arg6</span><span class="p">:</span> <span class="s2">&quot;Union[T6, ObjectRef[T6]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, DAGNode[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, DAGNode[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, DAGNode[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, DAGNode[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, DAGNode[T4]]&quot;</span><span class="p">,</span>
        <span class="n">__arg5</span><span class="p">:</span> <span class="s2">&quot;Union[T5, DAGNode[T5]]&quot;</span><span class="p">,</span>
        <span class="n">__arg6</span><span class="p">:</span> <span class="s2">&quot;Union[T6, DAGNode[T6]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DAGNode[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteFunction7</span><span class="p">(</span><span class="n">HasOptions</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, ObjectRef[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, ObjectRef[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, ObjectRef[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, ObjectRef[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, ObjectRef[T4]]&quot;</span><span class="p">,</span>
        <span class="n">__arg5</span><span class="p">:</span> <span class="s2">&quot;Union[T5, ObjectRef[T5]]&quot;</span><span class="p">,</span>
        <span class="n">__arg6</span><span class="p">:</span> <span class="s2">&quot;Union[T6, ObjectRef[T6]]&quot;</span><span class="p">,</span>
        <span class="n">__arg7</span><span class="p">:</span> <span class="s2">&quot;Union[T7, ObjectRef[T7]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, DAGNode[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, DAGNode[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, DAGNode[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, DAGNode[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, DAGNode[T4]]&quot;</span><span class="p">,</span>
        <span class="n">__arg5</span><span class="p">:</span> <span class="s2">&quot;Union[T5, DAGNode[T5]]&quot;</span><span class="p">,</span>
        <span class="n">__arg6</span><span class="p">:</span> <span class="s2">&quot;Union[T6, DAGNode[T6]]&quot;</span><span class="p">,</span>
        <span class="n">__arg7</span><span class="p">:</span> <span class="s2">&quot;Union[T7, DAGNode[T7]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DAGNode[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteFunction8</span><span class="p">(</span><span class="n">HasOptions</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, ObjectRef[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, ObjectRef[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, ObjectRef[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, ObjectRef[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, ObjectRef[T4]]&quot;</span><span class="p">,</span>
        <span class="n">__arg5</span><span class="p">:</span> <span class="s2">&quot;Union[T5, ObjectRef[T5]]&quot;</span><span class="p">,</span>
        <span class="n">__arg6</span><span class="p">:</span> <span class="s2">&quot;Union[T6, ObjectRef[T6]]&quot;</span><span class="p">,</span>
        <span class="n">__arg7</span><span class="p">:</span> <span class="s2">&quot;Union[T7, ObjectRef[T7]]&quot;</span><span class="p">,</span>
        <span class="n">__arg8</span><span class="p">:</span> <span class="s2">&quot;Union[T8, ObjectRef[T8]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, DAGNode[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, DAGNode[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, DAGNode[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, DAGNode[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, DAGNode[T4]]&quot;</span><span class="p">,</span>
        <span class="n">__arg5</span><span class="p">:</span> <span class="s2">&quot;Union[T5, DAGNode[T5]]&quot;</span><span class="p">,</span>
        <span class="n">__arg6</span><span class="p">:</span> <span class="s2">&quot;Union[T6, DAGNode[T6]]&quot;</span><span class="p">,</span>
        <span class="n">__arg7</span><span class="p">:</span> <span class="s2">&quot;Union[T7, DAGNode[T7]]&quot;</span><span class="p">,</span>
        <span class="n">__arg8</span><span class="p">:</span> <span class="s2">&quot;Union[T8, DAGNode[T8]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DAGNode[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteFunction9</span><span class="p">(</span><span class="n">HasOptions</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">,</span> <span class="n">T9</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">,</span> <span class="n">T9</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, ObjectRef[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, ObjectRef[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, ObjectRef[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, ObjectRef[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, ObjectRef[T4]]&quot;</span><span class="p">,</span>
        <span class="n">__arg5</span><span class="p">:</span> <span class="s2">&quot;Union[T5, ObjectRef[T5]]&quot;</span><span class="p">,</span>
        <span class="n">__arg6</span><span class="p">:</span> <span class="s2">&quot;Union[T6, ObjectRef[T6]]&quot;</span><span class="p">,</span>
        <span class="n">__arg7</span><span class="p">:</span> <span class="s2">&quot;Union[T7, ObjectRef[T7]]&quot;</span><span class="p">,</span>
        <span class="n">__arg8</span><span class="p">:</span> <span class="s2">&quot;Union[T8, ObjectRef[T8]]&quot;</span><span class="p">,</span>
        <span class="n">__arg9</span><span class="p">:</span> <span class="s2">&quot;Union[T9, ObjectRef[T9]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__arg0</span><span class="p">:</span> <span class="s2">&quot;Union[T0, DAGNode[T0]]&quot;</span><span class="p">,</span>
        <span class="n">__arg1</span><span class="p">:</span> <span class="s2">&quot;Union[T1, DAGNode[T1]]&quot;</span><span class="p">,</span>
        <span class="n">__arg2</span><span class="p">:</span> <span class="s2">&quot;Union[T2, DAGNode[T2]]&quot;</span><span class="p">,</span>
        <span class="n">__arg3</span><span class="p">:</span> <span class="s2">&quot;Union[T3, DAGNode[T3]]&quot;</span><span class="p">,</span>
        <span class="n">__arg4</span><span class="p">:</span> <span class="s2">&quot;Union[T4, DAGNode[T4]]&quot;</span><span class="p">,</span>
        <span class="n">__arg5</span><span class="p">:</span> <span class="s2">&quot;Union[T5, DAGNode[T5]]&quot;</span><span class="p">,</span>
        <span class="n">__arg6</span><span class="p">:</span> <span class="s2">&quot;Union[T6, DAGNode[T6]]&quot;</span><span class="p">,</span>
        <span class="n">__arg7</span><span class="p">:</span> <span class="s2">&quot;Union[T7, DAGNode[T7]]&quot;</span><span class="p">,</span>
        <span class="n">__arg8</span><span class="p">:</span> <span class="s2">&quot;Union[T8, DAGNode[T8]]&quot;</span><span class="p">,</span>
        <span class="n">__arg9</span><span class="p">:</span> <span class="s2">&quot;Union[T9, DAGNode[T9]]&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DAGNode[R]&quot;</span><span class="p">:</span>
        <span class="o">...</span>


<span class="c1"># Visible for testing.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_unhandled_error_handler</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Unhandled error (suppress with &#39;RAY_IGNORE_UNHANDLED_ERRORS=1&#39;): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Worker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class used to define the control flow of a worker process.</span>

<span class="sd">    Note:</span>
<span class="sd">        The methods in this class are considered unexposed to the user. The</span>
<span class="sd">        functions outside of this class are considered exposed.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        node (ray._private.node.Node): The node this worker is attached to.</span>
<span class="sd">        mode: The mode of the worker. One of SCRIPT_MODE, LOCAL_MODE, and</span>
<span class="sd">            WORKER_MODE.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a Worker object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># GPU object manager to manage GPU object lifecycles, including coordinating out-of-band</span>
        <span class="c1"># tensor transfers between actors, storing and retrieving GPU objects, and garbage collection.</span>
        <span class="c1"># We create the GPU object manager lazily, if a user specifies a</span>
        <span class="c1"># non-default tensor_transport, to avoid circular import and because it</span>
        <span class="c1"># imports third-party dependencies like PyTorch.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_object_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># When the worker is constructed. Record the original value of the</span>
        <span class="c1"># (CUDA_VISIBLE_DEVICES, ONEAPI_DEVICE_SELECTOR, HIP_VISIBLE_DEVICES,</span>
        <span class="c1"># NEURON_RT_VISIBLE_CORES, TPU_VISIBLE_CHIPS, ..) environment variables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_visible_accelerator_ids</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_visible_accelerator_ids</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># A dictionary that maps from driver id to SerializationContext</span>
        <span class="c1"># TODO: clean up the SerializationContext once the job finished.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialization_context_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_actor_manager</span> <span class="o">=</span> <span class="n">FunctionActorManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># This event is checked regularly by all of the threads so that they</span>
        <span class="c1"># know when to exit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads_stopped</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="c1"># If this is set, the next .remote call should drop into the</span>
        <span class="c1"># debugger, at the specified breakpoint ID.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugger_breakpoint</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="c1"># If this is set, ray.get calls invoked on the object ID returned</span>
        <span class="c1"># by the worker should drop into the debugger at the specified</span>
        <span class="c1"># breakpoint ID.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugger_get_breakpoint</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="c1"># If True, make the debugger external to the node this worker is</span>
        <span class="c1"># running on.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ray_debugger_external</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_code_from_local</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Opened file descriptor to stdout/stderr for this python worker.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_record_actor_task_log</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_ENABLE_RECORD_ACTOR_TASK_LOGGING</span>
        <span class="p">)</span>
        <span class="c1"># Whether rotation is enabled for out file and err file, task log position report will be skipped if rotation enabled, since the position cannot be accurate.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_rotation_enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_filepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_err_filepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Create the lock here because the serializer will use it before</span>
        <span class="c1"># initializing Ray.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="c1"># By default, don&#39;t show logs from other drivers. This is set to true by Serve</span>
        <span class="c1"># in order to stream logs from the controller and replica actors across</span>
        <span class="c1"># different drivers that connect to the same Serve instance.</span>
        <span class="c1"># See https://github.com/ray-project/ray/pull/35070.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_logs_by_job</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># the debugger port for this worker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debugger_port</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Cache the job id from initialize_job_config() to optimize lookups.</span>
        <span class="c1"># This is on the critical path of ray.get()/put() calls.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_job_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Indicates whether the worker is connected to the Ray cluster.</span>
        <span class="c1"># It should be set to True in `connect` and False in `disconnect`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gpu_object_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ray.experimental.GPUObjectManager&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_object_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We create the GPU object manager lazily, if a user specifies a</span>
            <span class="c1"># non-default tensor_transport, to avoid circular import and because it</span>
            <span class="c1"># imports third-party dependencies like PyTorch.</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">ray.experimental</span><span class="w"> </span><span class="kn">import</span> <span class="n">GPUObjectManager</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_object_manager</span> <span class="o">=</span> <span class="n">GPUObjectManager</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gpu_object_manager</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;bool: True if Ray has been started and False otherwise.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_connected</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span> <span class="o">=</span> <span class="n">is_connected</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">node_ip_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">node_ip_address</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_code_from_local</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_code_from_local</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_job_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_job_id</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_job_id</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">JobID</span><span class="o">.</span><span class="n">nil</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">actor_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_actor_id</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ActorID</span><span class="o">.</span><span class="n">nil</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">actor_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_actor_name</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_task_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_task_id</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_task_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_task_name</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_task_function_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_task_function_name</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_node_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_node_id</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">task_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_task_depth</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_job_config</span><span class="p">()</span><span class="o">.</span><span class="n">ray_namespace</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">placement_group_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_placement_group_id</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">worker_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_worker_id</span><span class="p">()</span><span class="o">.</span><span class="n">binary</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">should_capture_child_tasks_in_placement_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">should_capture_child_tasks_in_placement_group</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_cluster_and_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current session index and job id as pair.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">cluster_id</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">ClusterID</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_job_id</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">JobID</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">cluster_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_job_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">runtime_env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the runtime env in json format&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_runtime_env</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">debugger_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the debugger port for this worker&quot;&quot;&quot;</span>
        <span class="n">worker_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_worker_id</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get_worker_debugger_port</span><span class="p">(</span><span class="n">worker_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">job_logging_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the job&#39;s logging config for this worker&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">job_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_job_config</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">serialized_py_logging_config</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">logging_config</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">job_config</span><span class="o">.</span><span class="n">serialized_py_logging_config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logging_config</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_node_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Return the node labels of this worker&#39;s current node.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">node_labels</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_debugger_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="n">worker_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_worker_id</span><span class="p">()</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">update_worker_debugger_port</span><span class="p">(</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_cached_job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the cached job id to speed `current_job_id()`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_job_id</span> <span class="o">=</span> <span class="n">job_id</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">task_paused_by_debugger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use while the task is paused by debugger&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">update_task_is_debugger_paused</span><span class="p">(</span>
                <span class="n">ray</span><span class="o">.</span><span class="n">get_runtime_context</span><span class="p">()</span><span class="o">.</span><span class="n">_get_current_task_id</span><span class="p">(),</span> <span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">update_task_is_debugger_paused</span><span class="p">(</span>
                <span class="n">ray</span><span class="o">.</span><span class="n">get_runtime_context</span><span class="p">()</span><span class="o">.</span><span class="n">_get_current_task_id</span><span class="p">(),</span> <span class="kc">False</span>
            <span class="p">)</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">worker_paused_by_debugger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the worker num paused threads when the worker is paused by debugger</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">worker_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_worker_id</span><span class="p">()</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">update_worker_num_paused_threads</span><span class="p">(</span><span class="n">worker_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">update_worker_num_paused_threads</span><span class="p">(</span><span class="n">worker_id</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_file_rotation_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rotation_enabled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set whether rotation is enabled for outfile and errfile.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_rotation_enabled</span> <span class="o">=</span> <span class="n">rotation_enabled</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_err_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_filepath</span><span class="o">=</span><span class="n">Optional</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the worker&#39;s err file where stderr is redirected to&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_err_filepath</span> <span class="o">=</span> <span class="n">err_filepath</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_out_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_filepath</span><span class="o">=</span><span class="n">Optional</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the worker&#39;s out file where stdout is redirected to&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_filepath</span> <span class="o">=</span> <span class="n">out_filepath</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">record_task_log_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span> <span class="n">attempt_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record the task log info when task starts executing for</span>
<span class="sd">        non concurrent actor tasks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_record_actor_task_log</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor_id</span><span class="o">.</span><span class="n">is_nil</span><span class="p">():</span>
            <span class="c1"># We are not recording actor task log if not enabled explicitly.</span>
            <span class="c1"># Recording actor task log is expensive and should be enabled only</span>
            <span class="c1"># when needed.</span>
            <span class="c1"># https://github.com/ray-project/ray/issues/35598</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_rotation_enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">record_task_log_start</span><span class="p">(</span>
            <span class="n">task_id</span><span class="p">,</span>
            <span class="n">attempt_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_out_file_path</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_err_file_path</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_current_out_offset</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_current_err_offset</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">record_task_log_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span> <span class="n">attempt_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record the task log info when task finishes executing for</span>
<span class="sd">        non concurrent actor tasks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_record_actor_task_log</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor_id</span><span class="o">.</span><span class="n">is_nil</span><span class="p">():</span>
            <span class="c1"># We are not recording actor task log if not enabled explicitly.</span>
            <span class="c1"># Recording actor task log is expensive and should be enabled only</span>
            <span class="c1"># when needed.</span>
            <span class="c1"># https://github.com/ray-project/ray/issues/35598</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Disable file offset fetch if rotation enabled (since file offset doesn&#39;t make sense for rotated files).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_rotation_enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">record_task_log_end</span><span class="p">(</span>
            <span class="n">task_id</span><span class="p">,</span>
            <span class="n">attempt_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_current_out_offset</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_current_err_offset</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_out_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the out log file path&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_filepath</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_err_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the err log file path&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err_filepath</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_out_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current offset of the out file if seekable, else 0&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_out_filepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_err_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current offset of the err file if seekable, else 0&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_err_filepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_serialization_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the SerializationContext of the job that this worker is processing.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The serialization context of the given job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This function needs to be protected by a lock, because it will be</span>
        <span class="c1"># called by`register_class_for_serialization`, as well as the import</span>
        <span class="c1"># thread, from different threads. Also, this function will recursively</span>
        <span class="c1"># call itself, so we use RLock here.</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_job_id</span>
        <span class="n">context_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialization_context_map</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context_map</span><span class="p">:</span>
                <span class="c1"># The job ID is nil before initializing Ray.</span>
                <span class="k">if</span> <span class="n">JobID</span><span class="o">.</span><span class="n">nil</span><span class="p">()</span> <span class="ow">in</span> <span class="n">context_map</span><span class="p">:</span>
                    <span class="c1"># Transfer the serializer context used before initializing Ray.</span>
                    <span class="n">context_map</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">context_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">JobID</span><span class="o">.</span><span class="n">nil</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">context_map</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">SerializationContext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">context_map</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the worker is connected.</span>

<span class="sd">        Raises:</span>
<span class="sd">          Exception: An exception is raised if the worker is not connected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RaySystemError</span><span class="p">(</span>
                <span class="s2">&quot;Ray has not been started yet. You can start Ray with &#39;ray.init()&#39;.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the mode of the worker.</span>

<span class="sd">        The mode SCRIPT_MODE should be used if this Worker is a driver that is</span>
<span class="sd">        being run as a Python script or interactively in a shell. It will print</span>
<span class="sd">        information about task failures.</span>

<span class="sd">        The mode WORKER_MODE should be used if this Worker is not a driver. It</span>
<span class="sd">        will not print information about tasks.</span>

<span class="sd">        The mode LOCAL_MODE should be used if this Worker is a driver and if</span>
<span class="sd">        you want to run the driver in a manner equivalent to serial Python for</span>
<span class="sd">        debugging purposes. It will not send remote function calls to the</span>
<span class="sd">        scheduler and will instead execute them in a blocking fashion.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode: One of SCRIPT_MODE, WORKER_MODE, and LOCAL_MODE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_load_code_from_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load_code_from_local</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_code_from_local</span> <span class="o">=</span> <span class="n">load_code_from_local</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">put_object</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">object_ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ray.ObjectRef&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">owner_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_is_experimental_channel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Put value in the local object store with object reference `object_ref`.</span>

<span class="sd">        This assumes that the value for `object_ref` has not yet been placed in</span>
<span class="sd">        the local object store. If the plasma store is full, the worker will</span>
<span class="sd">        automatically retry up to DEFAULT_PUT_OBJECT_RETRIES times. Each</span>
<span class="sd">        retry will delay for an exponentially doubling amount of time,</span>
<span class="sd">        starting with DEFAULT_PUT_OBJECT_DELAY. After this, exception</span>
<span class="sd">        will be raised.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: The value to put in the object store.</span>
<span class="sd">            object_ref: The object ref of the value to be</span>
<span class="sd">                put. If None, one will be generated.</span>
<span class="sd">            owner_address: The serialized address of object&#39;s owner.</span>
<span class="sd">            _is_experimental_channel: An experimental flag for mutable</span>
<span class="sd">                objects. If True, then the returned object will not have a</span>
<span class="sd">                valid value. The object must be written to using the</span>
<span class="sd">                ray.experimental.channel API before readers can read.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ObjectRef: The object ref the object was put under.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ray.exceptions.ObjectStoreFullError: This is raised if the attempt</span>
<span class="sd">                to store the object fails because the object store is full even</span>
<span class="sd">                after multiple retries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure that the value is not an object ref.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ObjectRef</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Calling &#39;put&#39; on an ray.ObjectRef is not allowed. &quot;</span>
                <span class="s2">&quot;If you really want to do this, you can wrap the &quot;</span>
                <span class="s2">&quot;ray.ObjectRef in a list and call &#39;put&#39; on it.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">object_ref</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">),</span> <span class="s2">&quot;Local Mode does not support inserting with an ObjectRef&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">serialized_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serialization_context</span><span class="p">()</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">inspect_serializability</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">print_file</span><span class="o">=</span><span class="n">sio</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Could not serialize the put value &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="c1"># If the object is mutable, then the raylet should never read the</span>
        <span class="c1"># object. Instead, clients will keep the object pinned.</span>
        <span class="n">pin_object</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">_is_experimental_channel</span>

        <span class="c1"># This *must* be the first place that we construct this python</span>
        <span class="c1"># ObjectRef because an entry with 0 local references is created when</span>
        <span class="c1"># the object is Put() in the core worker, expecting that this python</span>
        <span class="c1"># reference will be created. If another reference is created and</span>
        <span class="c1"># removed before this one, it will corrupt the state in the</span>
        <span class="c1"># reference counter.</span>
        <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">put_serialized_object_and_increment_local_ref</span><span class="p">(</span>
                <span class="n">serialized_value</span><span class="p">,</span>
                <span class="n">object_ref</span><span class="o">=</span><span class="n">object_ref</span><span class="p">,</span>
                <span class="n">pin_object</span><span class="o">=</span><span class="n">pin_object</span><span class="p">,</span>
                <span class="n">owner_address</span><span class="o">=</span><span class="n">owner_address</span><span class="p">,</span>
                <span class="n">_is_experimental_channel</span><span class="o">=</span><span class="n">_is_experimental_channel</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="c1"># The initial local reference is already acquired internally.</span>
            <span class="n">skip_adding_local_ref</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">raise_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialized_objects</span><span class="p">,</span> <span class="n">object_refs</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize_objects</span><span class="p">(</span><span class="n">serialized_objects</span><span class="p">,</span> <span class="n">object_refs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;RAY_IGNORE_UNHANDLED_ERRORS&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">_unhandled_error_handler</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">deserialize_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialized_objects</span><span class="p">,</span> <span class="n">object_refs</span><span class="p">):</span>
        <span class="c1"># Function actor manager or the import thread may call pickle.loads</span>
        <span class="c1"># at the same time which can lead to failed imports</span>
        <span class="c1"># TODO: We may be better off locking on all imports or injecting a lock</span>
        <span class="c1"># into pickle.loads (https://github.com/ray-project/ray/issues/16304)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_actor_manager</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serialization_context</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">deserialize_objects</span><span class="p">(</span><span class="n">serialized_objects</span><span class="p">,</span> <span class="n">object_refs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_objects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">object_refs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_exceptions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">skip_deserialization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">serialization</span><span class="o">.</span><span class="n">SerializedRayObject</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the values in the object store associated with the IDs.</span>

<span class="sd">        Return the values from the local object store for object_refs. This</span>
<span class="sd">        will block until all the values for object_refs have been written to</span>
<span class="sd">        the local object store.</span>

<span class="sd">        Args:</span>
<span class="sd">            object_refs: A list of the object refs</span>
<span class="sd">                whose values should be retrieved.</span>
<span class="sd">            timeout: The maximum amount of time in</span>
<span class="sd">                seconds to wait before returning.</span>
<span class="sd">            return_exceptions: If any of the objects deserialize to an</span>
<span class="sd">                Exception object, whether to return them as values in the</span>
<span class="sd">                returned list. If False, then the first found exception will be</span>
<span class="sd">                raised.</span>
<span class="sd">            skip_deserialization: If true, only the buffer will be released and</span>
<span class="sd">                the object associated with the buffer will not be deserialized.</span>
<span class="sd">        Returns:</span>
<span class="sd">            list: List of deserialized objects or None if skip_deserialization is True.</span>
<span class="sd">            bytes: UUID of the debugger breakpoint we should drop</span>
<span class="sd">                into or b&quot;&quot; if there is no breakpoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure that the values are object refs.</span>
        <span class="k">for</span> <span class="n">object_ref</span> <span class="ow">in</span> <span class="n">object_refs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_ref</span><span class="p">,</span> <span class="n">ObjectRef</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Attempting to call `get` on the value </span><span class="si">{</span><span class="n">object_ref</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="s2">&quot;which is not an ray.ObjectRef.&quot;</span>
                <span class="p">)</span>

        <span class="n">timeout_ms</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">serialized_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span>
            <span class="n">serialization</span><span class="o">.</span><span class="n">SerializedRayObject</span>
        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_objects</span><span class="p">(</span>
            <span class="n">object_refs</span><span class="p">,</span>
            <span class="n">timeout_ms</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">debugger_breakpoint</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">serialized_objects</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
                <span class="n">metadata_fields</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_fields</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">metadata_fields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                    <span class="n">ray_constants</span><span class="o">.</span><span class="n">OBJECT_METADATA_DEBUG_PREFIX</span>
                <span class="p">):</span>
                    <span class="n">debugger_breakpoint</span> <span class="o">=</span> <span class="n">metadata_fields</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">OBJECT_METADATA_DEBUG_PREFIX</span><span class="p">)</span> <span class="p">:</span>
                    <span class="p">]</span>
        <span class="k">if</span> <span class="n">skip_deserialization</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">debugger_breakpoint</span>

        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize_objects</span><span class="p">(</span><span class="n">serialized_objects</span><span class="p">,</span> <span class="n">object_refs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_exceptions</span><span class="p">:</span>
            <span class="c1"># Raise exceptions instead of returning them to the user.</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">RayError</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ObjectLostError</span><span class="p">):</span>
                        <span class="n">global_worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">dump_object_store_memory_usage</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">RayTaskError</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">value</span><span class="o">.</span><span class="n">as_instanceof_cause</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">values</span><span class="p">,</span> <span class="n">debugger_breakpoint</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">main_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The main loop a worker runs to receive and execute tasks.&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">sigterm_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="n">raise_sys_exit_with_custom_error_message</span><span class="p">(</span>
                <span class="s2">&quot;The process receives a SIGTERM.&quot;</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="c1"># Note: shutdown() function is called from atexit handler.</span>

        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">set_sigterm_handler</span><span class="p">(</span><span class="n">sigterm_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">run_task_loop</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints log messages from workers on all nodes in the same job.&quot;&quot;&quot;</span>
        <span class="n">subscriber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcs_log_subscriber</span>
        <span class="n">subscriber</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>
        <span class="n">exception_type</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RpcError</span>
        <span class="n">localhost</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">get_node_ip_address</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Number of messages received from the last polling. When the batch</span>
            <span class="c1"># size exceeds 100 and keeps increasing, the worker and the user</span>
            <span class="c1"># probably will not be able to consume the log messages as rapidly</span>
            <span class="c1"># as they are coming in.</span>
            <span class="c1"># This is meaningful only for GCS subscriber.</span>
            <span class="n">last_polling_batch_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">job_id_hex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_job_id</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Exit if we received a signal that we should stop.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads_stopped</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">return</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
                <span class="c1"># GCS subscriber only returns None on unavailability.</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">last_polling_batch_size</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_filter_logs_by_job</span>
                    <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">job_id_hex</span>
                <span class="p">):</span>
                    <span class="n">last_polling_batch_size</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">continue</span>

                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;localhost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">localhost</span>
                <span class="n">global_worker_stdstream_dispatcher</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                <span class="n">lagging</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">last_polling_batch_size</span> <span class="o">&lt;</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">last_batch_size</span>
                <span class="k">if</span> <span class="n">lagging</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;The driver may not be able to keep up with the &quot;</span>
                        <span class="s2">&quot;stdout/stderr of the workers. To avoid forwarding &quot;</span>
                        <span class="s2">&quot;logs to the driver, use &quot;</span>
                        <span class="s2">&quot;&#39;ray.init(log_to_driver=False)&#39;.&quot;</span>
                    <span class="p">)</span>

                <span class="n">last_polling_batch_size</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">last_batch_size</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">exception_type</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;print_logs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Close the pubsub client to avoid leaking file descriptors.</span>
            <span class="n">subscriber</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_accelerator_ids_for_accelerator_resource</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource_regex</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the accelerator IDs that are assigned to the given accelerator resource.</span>

<span class="sd">        Args:</span>
<span class="sd">            resource_name: The name of the resource.</span>
<span class="sd">            resource_regex: The regex of the resource.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (List[str]) The IDs that are assigned to the given resource pre-configured.</span>
<span class="sd">            (List[int]) The IDs that are assigned to the given resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resource_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">resource_ids</span><span class="p">()</span>
        <span class="n">assigned_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># Handle both normal and placement group accelerator resources.</span>
        <span class="c1"># Note: We should only get the accelerator ids from the placement</span>
        <span class="c1"># group resource that does not contain the bundle index!</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

        <span class="k">for</span> <span class="n">resource</span><span class="p">,</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">resource_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">resource</span> <span class="o">==</span> <span class="n">resource_name</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">resource_regex</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">assignment</span><span class="p">:</span>
                    <span class="n">assigned_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>

        <span class="c1"># If the user had already set the environment variables</span>
        <span class="c1"># (CUDA_VISIBLE_DEVICES, ONEAPI_DEVICE_SELECTOR, NEURON_RT_VISIBLE_CORES,</span>
        <span class="c1"># TPU_VISIBLE_CHIPS, ..) then respect that in the sense that only IDs</span>
        <span class="c1"># that appear in (CUDA_VISIBLE_DEVICES, ONEAPI_DEVICE_SELECTOR,</span>
        <span class="c1"># HIP_VISIBLE_DEVICES, NEURON_RT_VISIBLE_CORES, TPU_VISIBLE_CHIPS, ..)</span>
        <span class="c1"># should be returned.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_visible_accelerator_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">original_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_visible_accelerator_ids</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span>
            <span class="n">assigned_ids</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">original_ids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">assigned_ids</span><span class="p">}</span>
            <span class="c1"># Give all accelerator ids in local_mode.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">resource_name</span> <span class="o">==</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">GPU</span><span class="p">:</span>
                    <span class="n">max_accelerators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_resource_spec</span><span class="p">()</span><span class="o">.</span><span class="n">num_gpus</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">max_accelerators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_resource_spec</span><span class="p">()</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">resource_name</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">max_accelerators</span><span class="p">:</span>
                    <span class="n">assigned_ids</span> <span class="o">=</span> <span class="n">original_ids</span><span class="p">[:</span><span class="n">max_accelerators</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">assigned_ids</span><span class="p">)</span>


<div class="viewcode-block" id="get_gpu_ids">
<a class="viewcode-back" href="../../../ray.html#ray.get_gpu_ids">[docs]</a>
<span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_gpu_ids</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the IDs of the GPUs that are available to the worker.</span>

<span class="sd">    This method should only be called inside of a task or actor, and not a driver.</span>

<span class="sd">    If the CUDA_VISIBLE_DEVICES environment variable was set when the worker</span>
<span class="sd">    started up, then the IDs returned by this method will be a subset of the</span>
<span class="sd">    IDs in CUDA_VISIBLE_DEVICES. If not, the IDs will fall in the range</span>
<span class="sd">    [0, NUM_GPUS - 1], where NUM_GPUS is the number of GPUs that the node has.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of GPU IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">worker</span><span class="o">.</span><span class="n">get_accelerator_ids_for_accelerator_resource</span><span class="p">(</span>
        <span class="n">ray_constants</span><span class="o">.</span><span class="n">GPU</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">GPU</span><span class="si">}</span><span class="s2">_group_[0-9A-Za-z]+$&quot;</span>
    <span class="p">)</span></div>



<span class="nd">@Deprecated</span><span class="p">(</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Use ray.get_runtime_context().get_assigned_resources() instead.&quot;</span><span class="p">,</span>
    <span class="n">warning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_resource_ids</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the IDs of the resources that are available to the worker.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary mapping the name of a resource to a list of pairs, where</span>
<span class="sd">        each pair consists of the ID of a resource and the fraction of that</span>
<span class="sd">        resource reserved for this worker.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">_mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;ray._private.worker.get_resource_ids() does not work in local_mode.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">resource_ids</span><span class="p">()</span>


<span class="nd">@Deprecated</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Use ray.init().address_info[&#39;webui_url&#39;] instead.&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_dashboard_url</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the URL to access the Ray dashboard.</span>

<span class="sd">    Note that the URL does not specify which node the dashboard is on.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The URL of the dashboard as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_OVERRIDE_DASHBOARD_URL</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_remove_protocol_from_url</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_OVERRIDE_DASHBOARD_URL</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_global_node</span><span class="o">.</span><span class="n">webui_url</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_remove_protocol_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to remove protocol from URL if it exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">url</span>
    <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>
        <span class="c1"># Construct URL without protocol</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">://&quot;</span>
        <span class="k">return</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">geturl</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">url</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BaseContext</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for RayContext and ClientContext</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dashboard_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">python_version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ray_version</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If this context is for directly attaching to a cluster, disconnect</span>
<span class="sd">        will call ray.shutdown(). Otherwise, if the context is for a ray</span>
<span class="sd">        client connection, the client will be disconnected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_context_table_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashboard_url</span><span class="p">:</span>
            <span class="n">dashboard_row</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;context_dashrow.html.j2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                <span class="n">dashboard_url</span><span class="o">=</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashboard_url</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dashboard_row</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;context_table.html.j2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">python_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">python_version</span><span class="p">,</span>
            <span class="n">ray_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ray_version</span><span class="p">,</span>
            <span class="n">dashboard_row</span><span class="o">=</span><span class="n">dashboard_row</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;context.html.j2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">context_logo</span><span class="o">=</span><span class="n">Template</span><span class="p">(</span><span class="s2">&quot;context_logo.html.j2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(),</span>
            <span class="n">context_table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context_table_template</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="nd">@repr_with_fallback</span><span class="p">([</span><span class="s2">&quot;ipywidgets&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_widget_bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the mimebundle for the widget representation of the context.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Passed to the _repr_mimebundle_() function for the widget</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary (&quot;mimebundle&quot;) of the widget representation of the context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span>

        <span class="n">disconnect_button</span> <span class="o">=</span> <span class="n">ipywidgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Disconnect&quot;</span><span class="p">,</span>
            <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">tooltip</span><span class="o">=</span><span class="s2">&quot;Disconnect from the Ray cluster&quot;</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">ipywidgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="s2">&quot;auto 0px 0px 0px&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">disconnect_callback</span><span class="p">(</span><span class="n">button</span><span class="p">):</span>
            <span class="n">button</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">button</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Disconnecting...&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="n">button</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Disconnected&quot;</span>

        <span class="n">disconnect_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">disconnect_callback</span><span class="p">)</span>
        <span class="n">left_content</span> <span class="o">=</span> <span class="n">ipywidgets</span><span class="o">.</span><span class="n">VBox</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">ipywidgets</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="s2">&quot;context_logo.html.j2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">()),</span>
                <span class="n">disconnect_button</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">ipywidgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">right_content</span> <span class="o">=</span> <span class="n">ipywidgets</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context_table_template</span><span class="p">())</span>
        <span class="n">widget</span> <span class="o">=</span> <span class="n">ipywidgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span>
            <span class="p">[</span><span class="n">left_content</span><span class="p">,</span> <span class="n">right_content</span><span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="n">ipywidgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">widget</span><span class="o">.</span><span class="n">_repr_mimebundle_</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_repr_mimebundle_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_widget_bundle</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Overwrite the widget html repr and default repr with those of the BaseContext</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;text/html&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">(),</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">bundle</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RayContext</span><span class="p">(</span><span class="n">BaseContext</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager for attached drivers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dashboard_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">python_version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ray_version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ray_commit</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard_url</span> <span class="o">=</span> <span class="n">get_dashboard_url</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">python_version</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ray_version</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">__version__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ray_commit</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">__commit__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address_info</span> <span class="o">=</span> <span class="n">address_info</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;ray_context_getitem&quot;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Accessing values through ctx[&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot;] is deprecated. &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Use ctx.address_info[&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot;] instead.&#39;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;ray_context_len&quot;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;len(ctx) is deprecated. Use len(ctx.address_info) instead.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_info</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;ray_context_len&quot;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;iter(ctx) is deprecated. Use iter(ctx.address_info) instead.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_info</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RayContext&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc</span><span class="p">):</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Include disconnect() to stay consistent with ClientContext</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>


<span class="n">global_worker</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Worker: The global Worker object for this worker process.</span>

<span class="sd">We use a global Worker object to ensure that there is a single worker object</span>
<span class="sd">per worker process.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">_global_node</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;ray._private.node.Node: The global node object that is created by ray.init().&quot;&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_maybe_modify_runtime_env</span><span class="p">(</span>
    <span class="n">runtime_env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">_skip_env_hook</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If you set RAY_ENABLE_UV_RUN_RUNTIME_ENV, which is the default, and run the driver with `uv run`,</span>
<span class="sd">    this function sets up a runtime environment that replicates the driver&#39;s environment to the</span>
<span class="sd">    workers. Otherwise, if a runtime environment hook is present it will modify the runtime environment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_ENABLE_UV_RUN_RUNTIME_ENV</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.runtime_env.uv_runtime_env_hook</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">_get_uv_run_cmdline</span><span class="p">,</span>
            <span class="n">hook</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">cmdline</span> <span class="o">=</span> <span class="n">_get_uv_run_cmdline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cmdline</span><span class="p">:</span>
            <span class="c1"># This means the current driver is running in `uv run`, in which case we want</span>
            <span class="c1"># to propagate the uv environment to the workers.</span>
            <span class="k">return</span> <span class="n">hook</span><span class="p">(</span><span class="n">runtime_env</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_RUNTIME_ENV_HOOK</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_skip_env_hook</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_class</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_RUNTIME_ENV_HOOK</span><span class="p">])(</span><span class="n">runtime_env</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">runtime_env</span>


<div class="viewcode-block" id="init">
<a class="viewcode-back" href="../../../ray.html#ray.init">[docs]</a>
<span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span>
    <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">num_cpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_gpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">resources</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">object_store_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ignore_reinit_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">include_dashboard</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dashboard_host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">DEFAULT_DASHBOARD_IP</span><span class="p">,</span>
    <span class="n">dashboard_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">job_config</span><span class="p">:</span> <span class="s2">&quot;ray.job_config.JobConfig&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">configure_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">logging_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">LOGGER_LEVEL</span><span class="p">,</span>
    <span class="n">logging_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">logging_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LoggingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">log_to_driver</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">runtime_env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="s2">&quot;RuntimeEnv&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: F821</span>
    <span class="n">enable_resource_isolation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">system_reserved_cpu</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">system_reserved_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connect to an existing Ray cluster or start one and connect to it.</span>

<span class="sd">    This method handles two cases; either a Ray cluster already exists and we</span>
<span class="sd">    just attach this driver to it or we start all of the processes associated</span>
<span class="sd">    with a Ray cluster and attach to the newly started cluster.</span>
<span class="sd">    Note: This method overwrite sigterm handler of the driver process.</span>

<span class="sd">    In most cases, it is enough to just call this method with no arguments.</span>
<span class="sd">    This will autodetect an existing Ray cluster or start a new Ray instance if</span>
<span class="sd">    no existing cluster is found:</span>

<span class="sd">    .. testcode::</span>

<span class="sd">        ray.init()</span>

<span class="sd">    To explicitly connect to an existing local cluster, use this as follows. A</span>
<span class="sd">    ConnectionError will be thrown if no existing local cluster is found.</span>

<span class="sd">    .. testcode::</span>
<span class="sd">        :skipif: True</span>

<span class="sd">        ray.init(address=&quot;auto&quot;)</span>

<span class="sd">    To connect to an existing remote cluster, use this as follows (substituting</span>
<span class="sd">    in the appropriate address). Note the addition of &quot;ray://&quot; at the beginning</span>
<span class="sd">    of the address. This requires `ray[client]`.</span>

<span class="sd">    .. testcode::</span>
<span class="sd">        :skipif: True</span>

<span class="sd">        ray.init(address=&quot;ray://123.45.67.89:10001&quot;)</span>

<span class="sd">    More details for starting and connecting to a remote cluster can be found</span>
<span class="sd">    here: https://docs.ray.io/en/master/cluster/getting-started.html</span>

<span class="sd">    You can also define an environment variable called `RAY_ADDRESS` in</span>
<span class="sd">    the same format as the `address` parameter to connect to an existing</span>
<span class="sd">    cluster with ray.init() or ray.init(address=&quot;auto&quot;).</span>

<span class="sd">    Args:</span>
<span class="sd">        address: The address of the Ray cluster to connect to. The provided</span>
<span class="sd">            address is resolved as follows:</span>
<span class="sd">            1. If a concrete address (e.g., localhost:&lt;port&gt;) is provided, try to</span>
<span class="sd">            connect to it. Concrete addresses can be prefixed with &quot;ray://&quot; to</span>
<span class="sd">            connect to a remote cluster. For example, passing in the address</span>
<span class="sd">            &quot;ray://123.45.67.89:50005&quot; will connect to the cluster at the given</span>
<span class="sd">            address.</span>
<span class="sd">            2. If no address is provided, try to find an existing Ray instance</span>
<span class="sd">            to connect to. This is done by first checking the environment</span>
<span class="sd">            variable `RAY_ADDRESS`. If this is not defined, check the address</span>
<span class="sd">            of the latest cluster started (found in</span>
<span class="sd">            /tmp/ray/ray_current_cluster) if available. If this is also empty,</span>
<span class="sd">            then start a new local Ray instance.</span>
<span class="sd">            3. If the provided address is &quot;auto&quot;, then follow the same process</span>
<span class="sd">            as above. However, if there is no existing cluster found, this will</span>
<span class="sd">            throw a ConnectionError instead of starting a new local Ray</span>
<span class="sd">            instance.</span>
<span class="sd">            4. If the provided address is &quot;local&quot;, start a new local Ray</span>
<span class="sd">            instance, even if there is already an existing local Ray instance.</span>
<span class="sd">        num_cpus: Number of CPUs the user wishes to assign to each</span>
<span class="sd">            raylet. By default, this is set based on virtual cores.</span>
<span class="sd">        num_gpus: Number of GPUs the user wishes to assign to each</span>
<span class="sd">            raylet. By default, this is set based on detected GPUs.</span>
<span class="sd">        resources: A dictionary mapping the names of custom resources to the</span>
<span class="sd">            quantities for them available.</span>
<span class="sd">        labels: [Experimental] The key-value labels of the node.</span>
<span class="sd">        object_store_memory: The amount of memory (in bytes) to start the</span>
<span class="sd">            object store with.</span>
<span class="sd">            By default, this is 30% of available system memory capped by</span>
<span class="sd">            the shm size and 200G but can be set higher.</span>
<span class="sd">        local_mode: Deprecated: consider using the Ray Debugger instead.</span>
<span class="sd">        ignore_reinit_error: If true, Ray suppresses errors from calling</span>
<span class="sd">            ray.init() a second time. Ray won&#39;t be restarted.</span>
<span class="sd">        include_dashboard: Boolean flag indicating whether or not to start the</span>
<span class="sd">            Ray dashboard, which displays the status of the Ray</span>
<span class="sd">            cluster. If this argument is None, then the UI will be started if</span>
<span class="sd">            the relevant dependencies are present.</span>
<span class="sd">        dashboard_host: The host to bind the dashboard server to. Can either be</span>
<span class="sd">            localhost (127.0.0.1) or 0.0.0.0 (available from all interfaces).</span>
<span class="sd">            By default, this is set to localhost to prevent access from</span>
<span class="sd">            external machines.</span>
<span class="sd">        dashboard_port(int, None): The port to bind the dashboard server to.</span>
<span class="sd">            Defaults to 8265 and Ray will automatically find a free port if</span>
<span class="sd">            8265 is not available.</span>
<span class="sd">        job_config (ray.job_config.JobConfig): The job configuration.</span>
<span class="sd">        configure_logging: True (default) if configuration of logging is</span>
<span class="sd">            allowed here. Otherwise, the user may want to configure it</span>
<span class="sd">            separately.</span>
<span class="sd">        logging_level: Logging level for the &quot;ray&quot; logger of the driver process,</span>
<span class="sd">            defaults to logging.INFO. Ignored unless &quot;configure_logging&quot; is true.</span>
<span class="sd">        logging_format: Logging format for the &quot;ray&quot; logger of the driver process,</span>
<span class="sd">            defaults to a string containing a timestamp, filename, line number, and</span>
<span class="sd">            message. See the source file ray_constants.py for details. Ignored unless</span>
<span class="sd">            &quot;configure_logging&quot; is true.</span>
<span class="sd">        logging_config: [Experimental] Logging configuration will be applied to the</span>
<span class="sd">            root loggers for both the driver process and all worker processes belonging</span>
<span class="sd">            to the current job. See :class:`~ray.LoggingConfig` for details.</span>
<span class="sd">        log_to_driver: If true, the output from all of the worker</span>
<span class="sd">            processes on all nodes will be directed to the driver.</span>
<span class="sd">        namespace: A namespace is a logical grouping of jobs and named actors.</span>
<span class="sd">        runtime_env: The runtime environment to use</span>
<span class="sd">            for this job (see :ref:`runtime-environments` for details).</span>
<span class="sd">        object_spilling_directory: The path to spill objects to. The same path will</span>
<span class="sd">            be used as the object store fallback directory as well.</span>
<span class="sd">        enable_resource_isolation: Enable resource isolation through cgroupv2 by reserving</span>
<span class="sd">            memory and cpu resources for ray system processes. To use, only cgroupv2 (not cgroupv1)</span>
<span class="sd">            must be enabled with read and write permissions for the raylet. Cgroup memory and</span>
<span class="sd">            cpu controllers must also be enabled.</span>
<span class="sd">        system_reserved_cpu: The amount of cpu cores to reserve for ray system processes. Cores can be</span>
<span class="sd">            fractional i.e. 0.5 means half a cpu core.</span>
<span class="sd">            By default, the min of 20% and 1 core will be reserved.</span>
<span class="sd">            Must be &gt;= 0.5 cores and &lt; total number of available cores.</span>
<span class="sd">            Cannot be less than 0.5 cores.</span>
<span class="sd">            This option only works if enable_resource_isolation is True.</span>
<span class="sd">        system_reserved_memory: The amount of memory (in bytes) to reserve for ray system processes.</span>
<span class="sd">            By default, the min of 10% and 25GB plus object_store_memory will be reserved.</span>
<span class="sd">            Must be &gt;= 100MB and system_reserved_memory + object_store_bytes &lt; total available memory.</span>
<span class="sd">            This option only works if enable_resource_isolation is True.</span>
<span class="sd">        _cgroup_path: The path for the cgroup the raylet should use to enforce resource isolation.</span>
<span class="sd">            By default, the cgroup used for resource isolation will be /sys/fs/cgroup.</span>
<span class="sd">            The raylet must have read/write permissions to this path.</span>
<span class="sd">            Cgroup memory and cpu controllers be enabled for this cgroup.</span>
<span class="sd">            This option only works if enable_resource_isolation is True.</span>
<span class="sd">        _enable_object_reconstruction: If True, when an object stored in</span>
<span class="sd">            the distributed plasma store is lost due to node failure, Ray will</span>
<span class="sd">            attempt to reconstruct the object by re-executing the task that</span>
<span class="sd">            created the object. Arguments to the task will be recursively</span>
<span class="sd">            reconstructed. If False, then ray.ObjectLostError will be</span>
<span class="sd">            thrown.</span>
<span class="sd">        _plasma_directory: Override the plasma mmap file directory.</span>
<span class="sd">        _node_ip_address: The IP address of the node that we are on.</span>
<span class="sd">        _driver_object_store_memory: Deprecated.</span>
<span class="sd">        _memory: Amount of reservable memory resource in bytes rounded</span>
<span class="sd">            down to the nearest integer.</span>
<span class="sd">        _redis_username: Prevents external clients without the username</span>
<span class="sd">            from connecting to Redis if provided.</span>
<span class="sd">        _redis_password: Prevents external clients without the password</span>
<span class="sd">            from connecting to Redis if provided.</span>
<span class="sd">        _temp_dir: If provided, specifies the root temporary</span>
<span class="sd">            directory for the Ray process. Must be an absolute path. Defaults to an</span>
<span class="sd">            OS-specific conventional location, e.g., &quot;/tmp/ray&quot;.</span>
<span class="sd">        _metrics_export_port: Port number Ray exposes system metrics</span>
<span class="sd">            through a Prometheus endpoint. It is currently under active</span>
<span class="sd">            development, and the API is subject to change.</span>
<span class="sd">        _system_config: Configuration for overriding</span>
<span class="sd">            RayConfig defaults. For testing purposes ONLY.</span>
<span class="sd">        _tracing_startup_hook: If provided, turns on and sets up tracing</span>
<span class="sd">            for Ray. Must be the name of a function that takes no arguments and</span>
<span class="sd">            sets up a Tracer Provider, Remote Span Processors, and</span>
<span class="sd">            (optional) additional instruments. See more at</span>
<span class="sd">            docs.ray.io/tracing.html. It is currently under active development,</span>
<span class="sd">            and the API is subject to change.</span>
<span class="sd">        _node_name: User-provided node name or identifier. Defaults to</span>
<span class="sd">            the node IP address.</span>

<span class="sd">    Returns:</span>
<span class="sd">        If the provided address includes a protocol, for example by prepending</span>
<span class="sd">        &quot;ray://&quot; to the address to get &quot;ray://1.2.3.4:10001&quot;, then a</span>
<span class="sd">        ClientContext is returned with information such as settings, server</span>
<span class="sd">        versions for ray and python, and the dashboard_url. Otherwise,</span>
<span class="sd">        a RayContext is returned with ray and python versions, and address</span>
<span class="sd">        information about the started processes.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: An exception is raised if an inappropriate combination of</span>
<span class="sd">            arguments is passed in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">log_to_driver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_to_driver</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_LOG_TO_DRIVER</span>

    <span class="c1"># Configure the &quot;ray&quot; logger for the driver process.</span>
    <span class="k">if</span> <span class="n">configure_logging</span><span class="p">:</span>
        <span class="n">setup_logger</span><span class="p">(</span><span class="n">logging_level</span><span class="p">,</span> <span class="n">logging_format</span> <span class="ow">or</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">LOGGER_FORMAT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ray&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># Configure the logging settings for the driver process.</span>
    <span class="k">if</span> <span class="n">logging_config</span> <span class="ow">or</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_LOGGING_CONFIG_ENCODING</span><span class="p">:</span>
        <span class="n">logging_config</span> <span class="o">=</span> <span class="n">logging_config</span> <span class="ow">or</span> <span class="n">LoggingConfig</span><span class="p">(</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_LOGGING_CONFIG_ENCODING</span>
        <span class="p">)</span>
        <span class="n">logging_config</span><span class="o">.</span><span class="n">_apply</span><span class="p">()</span>

    <span class="c1"># Parse the hidden options</span>
    <span class="n">_cgroup_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_cgroup_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">_enable_object_reconstruction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
        <span class="s2">&quot;_enable_object_reconstruction&quot;</span><span class="p">,</span> <span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">_plasma_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_plasma_directory&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">_object_spilling_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
        <span class="s2">&quot;object_spilling_directory&quot;</span><span class="p">,</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">_node_ip_address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_node_ip_address&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">_driver_object_store_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
        <span class="s2">&quot;_driver_object_store_memory&quot;</span><span class="p">,</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_memory&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">_redis_username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
        <span class="s2">&quot;_redis_username&quot;</span><span class="p">,</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">REDIS_DEFAULT_USERNAME</span>
    <span class="p">)</span>
    <span class="n">_redis_password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
        <span class="s2">&quot;_redis_password&quot;</span><span class="p">,</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">REDIS_DEFAULT_PASSWORD</span>
    <span class="p">)</span>
    <span class="n">_temp_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_temp_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">_metrics_export_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_metrics_export_port&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">_system_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_system_config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">_tracing_startup_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
        <span class="s2">&quot;_tracing_startup_hook&quot;</span><span class="p">,</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">_node_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_node_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># Fix for https://github.com/ray-project/ray/issues/26729</span>
    <span class="n">_skip_env_hook</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_skip_env_hook&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">resource_isolation_config</span> <span class="o">=</span> <span class="n">ResourceIsolationConfig</span><span class="p">(</span>
        <span class="n">enable_resource_isolation</span><span class="o">=</span><span class="n">enable_resource_isolation</span><span class="p">,</span>
        <span class="n">cgroup_path</span><span class="o">=</span><span class="n">_cgroup_path</span><span class="p">,</span>
        <span class="n">system_reserved_cpu</span><span class="o">=</span><span class="n">system_reserved_cpu</span><span class="p">,</span>
        <span class="n">system_reserved_memory</span><span class="o">=</span><span class="n">system_reserved_memory</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># terminate any signal before connecting driver</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sigterm_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">signum</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span> <span class="ow">is</span> <span class="n">threading</span><span class="o">.</span><span class="n">main_thread</span><span class="p">():</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">set_sigterm_handler</span><span class="p">(</span><span class="n">sigterm_handler</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;SIGTERM handler is not set because current thread &quot;</span>
            <span class="s2">&quot;is not the main thread.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># If available, use RAY_ADDRESS to override if the address was left</span>
    <span class="c1"># unspecified, or set to &quot;auto&quot; in the call to init</span>
    <span class="n">address_env_var</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_ADDRESS_ENVIRONMENT_VARIABLE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">address_env_var</span> <span class="ow">and</span> <span class="p">(</span><span class="n">address</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">address</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">address_env_var</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Using address </span><span class="si">{</span><span class="n">address_env_var</span><span class="si">}</span><span class="s2"> set in the environment &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;variable </span><span class="si">{</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_ADDRESS_ENVIRONMENT_VARIABLE</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;://&quot;</span> <span class="ow">in</span> <span class="n">address</span><span class="p">:</span>
        <span class="c1"># Address specified a protocol, use ray client</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">_deprecation_warn_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Forward any keyword arguments that were changed from their default</span>
        <span class="c1"># values to the builder</span>
        <span class="n">init_sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
        <span class="n">passed_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">argument_name</span><span class="p">,</span> <span class="n">param_obj</span> <span class="ow">in</span> <span class="n">init_sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">argument_name</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">}:</span>
                <span class="c1"># kwargs and address are handled separately</span>
                <span class="k">continue</span>
            <span class="n">default_value</span> <span class="o">=</span> <span class="n">param_obj</span><span class="o">.</span><span class="n">default</span>
            <span class="n">passed_value</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">argument_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">passed_value</span> <span class="o">!=</span> <span class="n">default_value</span><span class="p">:</span>
                <span class="c1"># passed value is different than default, pass to the client</span>
                <span class="c1"># builder</span>
                <span class="n">passed_kwargs</span><span class="p">[</span><span class="n">argument_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">passed_value</span>
        <span class="n">passed_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">_init_args</span><span class="p">(</span><span class="o">**</span><span class="n">passed_kwargs</span><span class="p">)</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.usage</span><span class="w"> </span><span class="kn">import</span> <span class="n">usage_lib</span>

        <span class="k">if</span> <span class="n">passed_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allow_multiple&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">usage_lib</span><span class="o">.</span><span class="n">put_pre_init_usage_stats</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">usage_lib</span><span class="o">.</span><span class="n">put_pre_init_usage_stats</span><span class="p">()</span>

        <span class="n">usage_lib</span><span class="o">.</span><span class="n">record_library_usage</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allow_multiple&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;`allow_multiple` argument is passed to `ray.init` when the &quot;</span>
            <span class="s2">&quot;ray client is not used (&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;https://docs.ray.io/en/</span><span class="si">{</span><span class="n">get_ray_doc_version</span><span class="p">()</span><span class="si">}</span><span class="s2">/cluster&quot;</span>
            <span class="s2">&quot;/running-applications/job-submission&quot;</span>
            <span class="s2">&quot;/ray-client.html#connect-to-multiple-ray-clusters-experimental). &quot;</span>
            <span class="s2">&quot;Do not pass the `allow_multiple` to `ray.init` to fix the issue.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;storage&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Cluster-wide storage configuration has been removed. &quot;</span>
            <span class="s2">&quot;The last Ray version supporting the `storage` argument is `ray==2.47`.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="c1"># User passed in extra keyword arguments but isn&#39;t connecting through</span>
        <span class="c1"># ray client. Raise an error, since most likely a typo in keyword</span>
        <span class="n">unknown</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown keyword argument(s): </span><span class="si">{</span><span class="n">unknown</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Try to increase the file descriptor limit, which is too low by</span>
    <span class="c1"># default for Ray: https://github.com/ray-project/ray/issues/11239</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">resource</span>

        <span class="n">soft</span><span class="p">,</span> <span class="n">hard</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">soft</span> <span class="o">&lt;</span> <span class="n">hard</span><span class="p">:</span>
            <span class="c1"># https://github.com/ray-project/ray/issues/12059</span>
            <span class="n">soft</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">soft</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">hard</span><span class="p">,</span> <span class="mi">65536</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Automatically increasing RLIMIT_NOFILE to max value of </span><span class="si">{</span><span class="n">hard</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">,</span> <span class="p">(</span><span class="n">soft</span><span class="p">,</span> <span class="n">hard</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to raise limit.&quot;</span><span class="p">)</span>
        <span class="n">soft</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">soft</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;File descriptor limit </span><span class="si">{}</span><span class="s2"> is too low for production &quot;</span>
                <span class="s2">&quot;servers and may result in connection errors. &quot;</span>
                <span class="s2">&quot;At least 8192 is recommended. --- &quot;</span>
                <span class="s2">&quot;Fix with &#39;ulimit -n 8192&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">soft</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Could not import resource module (on Windows)&quot;</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">job_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">job_config</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">job_config</span><span class="o">.</span><span class="n">JobConfig</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">RAY_JOB_CONFIG_JSON_ENV_VAR</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">injected_job_config_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">RAY_JOB_CONFIG_JSON_ENV_VAR</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">injected_job_config</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">job_config</span><span class="o">.</span><span class="n">JobConfig</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">job_config</span><span class="o">.</span><span class="n">JobConfig</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">injected_job_config_json</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">driver_runtime_env</span> <span class="o">=</span> <span class="n">runtime_env</span>
        <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">_merge_runtime_env</span><span class="p">(</span>
            <span class="n">injected_job_config</span><span class="o">.</span><span class="n">runtime_env</span><span class="p">,</span>
            <span class="n">driver_runtime_env</span><span class="p">,</span>
            <span class="n">override</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RAY_OVERRIDE_JOB_RUNTIME_ENV&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">runtime_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># None means there was a conflict.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Failed to merge the Job&#39;s runtime env &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">injected_job_config</span><span class="o">.</span><span class="n">runtime_env</span><span class="si">}</span><span class="s2"> with &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;a ray.init&#39;s runtime env </span><span class="si">{</span><span class="n">driver_runtime_env</span><span class="si">}</span><span class="s2"> because &quot;</span>
                <span class="s2">&quot;of a conflict. Specifying the same runtime_env fields &quot;</span>
                <span class="s2">&quot;or the same environment variable keys is not allowed. &quot;</span>
                <span class="s2">&quot;Use RAY_OVERRIDE_JOB_RUNTIME_ENV=1 to instruct Ray to &quot;</span>
                <span class="s2">&quot;combine Job and Driver&#39;s runtime environment in the event of &quot;</span>
                <span class="s2">&quot;a conflict.&quot;</span>
            <span class="p">)</span>

        <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">_maybe_modify_runtime_env</span><span class="p">(</span><span class="n">runtime_env</span><span class="p">,</span> <span class="n">_skip_env_hook</span><span class="p">)</span>

        <span class="n">job_config</span><span class="o">.</span><span class="n">set_runtime_env</span><span class="p">(</span><span class="n">runtime_env</span><span class="p">)</span>
        <span class="c1"># Similarly, we prefer metadata provided via job submission API</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">injected_job_config</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># RAY_JOB_CONFIG_JSON_ENV_VAR is only set at ray job manager level and has</span>
    <span class="c1"># higher priority in case user also provided runtime_env for ray.init()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">_maybe_modify_runtime_env</span><span class="p">(</span><span class="n">runtime_env</span><span class="p">,</span> <span class="n">_skip_env_hook</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">runtime_env</span><span class="p">:</span>
            <span class="c1"># Set runtime_env in job_config if passed in as part of ray.init()</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">set_runtime_env</span><span class="p">(</span><span class="n">runtime_env</span><span class="p">)</span>

    <span class="c1"># Pass the logging_config to job_config to configure loggers of all worker</span>
    <span class="c1"># processes belonging to the job.</span>
    <span class="k">if</span> <span class="n">logging_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">job_config</span><span class="o">.</span><span class="n">set_py_logging_config</span><span class="p">(</span><span class="n">logging_config</span><span class="p">)</span>

    <span class="n">redis_address</span><span class="p">,</span> <span class="n">gcs_address</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">bootstrap_address</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">canonicalize_bootstrap_address</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">_temp_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bootstrap_address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gcs_address</span> <span class="o">=</span> <span class="n">bootstrap_address</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connecting to existing Ray cluster at address: </span><span class="si">%s</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">gcs_address</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">local_mode</span><span class="p">:</span>
        <span class="n">driver_mode</span> <span class="o">=</span> <span class="n">LOCAL_MODE</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;DeprecationWarning: local mode is an experimental feature that is no &quot;</span>
            <span class="s2">&quot;longer maintained and will be removed in the future.&quot;</span>
            <span class="s2">&quot;For debugging consider using Ray debugger. &quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">driver_mode</span> <span class="o">=</span> <span class="n">SCRIPT_MODE</span>

    <span class="k">global</span> <span class="n">_global_node</span>

    <span class="k">if</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ignore_reinit_error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calling ray.init() again after it has already been called.&quot;</span><span class="p">)</span>
            <span class="n">node_id</span> <span class="o">=</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_node_id</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">RayContext</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">_global_node</span><span class="o">.</span><span class="n">address_info</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node_id</span><span class="o">.</span><span class="n">hex</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Maybe you called ray.init twice by accident? &quot;</span>
                <span class="s2">&quot;This error can be suppressed by passing in &quot;</span>
                <span class="s2">&quot;&#39;ignore_reinit_error=True&#39; or by calling &quot;</span>
                <span class="s2">&quot;&#39;ray.shutdown()&#39; prior to &#39;ray.init()&#39;.&quot;</span>
            <span class="p">)</span>

    <span class="n">_system_config</span> <span class="o">=</span> <span class="n">_system_config</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_system_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The _system_config must be a dict.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bootstrap_address</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># In this case, we need to start a new cluster.</span>

        <span class="c1"># Don&#39;t collect usage stats in ray.init() unless it&#39;s a nightly wheel.</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.usage</span><span class="w"> </span><span class="kn">import</span> <span class="n">usage_lib</span>

        <span class="k">if</span> <span class="n">usage_lib</span><span class="o">.</span><span class="n">is_nightly_wheel</span><span class="p">():</span>
            <span class="n">usage_lib</span><span class="o">.</span><span class="n">show_usage_stats_prompt</span><span class="p">(</span><span class="n">cli</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">usage_lib</span><span class="o">.</span><span class="n">set_usage_stats_enabled_via_env_var</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Use a random port by not specifying Redis port / GCS server port.</span>
        <span class="n">ray_params</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">RayParams</span><span class="p">(</span>
            <span class="n">node_ip_address</span><span class="o">=</span><span class="n">_node_ip_address</span><span class="p">,</span>
            <span class="n">driver_mode</span><span class="o">=</span><span class="n">driver_mode</span><span class="p">,</span>
            <span class="n">redirect_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">num_cpus</span><span class="o">=</span><span class="n">num_cpus</span><span class="p">,</span>
            <span class="n">num_gpus</span><span class="o">=</span><span class="n">num_gpus</span><span class="p">,</span>
            <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">num_redis_shards</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">redis_max_clients</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">redis_username</span><span class="o">=</span><span class="n">_redis_username</span><span class="p">,</span>
            <span class="n">redis_password</span><span class="o">=</span><span class="n">_redis_password</span><span class="p">,</span>
            <span class="n">plasma_directory</span><span class="o">=</span><span class="n">_plasma_directory</span><span class="p">,</span>
            <span class="n">object_spilling_directory</span><span class="o">=</span><span class="n">_object_spilling_directory</span><span class="p">,</span>
            <span class="n">huge_pages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">include_dashboard</span><span class="o">=</span><span class="n">include_dashboard</span><span class="p">,</span>
            <span class="n">dashboard_host</span><span class="o">=</span><span class="n">dashboard_host</span><span class="p">,</span>
            <span class="n">dashboard_port</span><span class="o">=</span><span class="n">dashboard_port</span><span class="p">,</span>
            <span class="n">memory</span><span class="o">=</span><span class="n">_memory</span><span class="p">,</span>
            <span class="n">object_store_memory</span><span class="o">=</span><span class="n">object_store_memory</span><span class="p">,</span>
            <span class="n">plasma_store_socket_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">temp_dir</span><span class="o">=</span><span class="n">_temp_dir</span><span class="p">,</span>
            <span class="n">_system_config</span><span class="o">=</span><span class="n">_system_config</span><span class="p">,</span>
            <span class="n">enable_object_reconstruction</span><span class="o">=</span><span class="n">_enable_object_reconstruction</span><span class="p">,</span>
            <span class="n">metrics_export_port</span><span class="o">=</span><span class="n">_metrics_export_port</span><span class="p">,</span>
            <span class="n">tracing_startup_hook</span><span class="o">=</span><span class="n">_tracing_startup_hook</span><span class="p">,</span>
            <span class="n">node_name</span><span class="o">=</span><span class="n">_node_name</span><span class="p">,</span>
            <span class="n">resource_isolation_config</span><span class="o">=</span><span class="n">resource_isolation_config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Start the Ray processes. We set shutdown_at_exit=False because we</span>
        <span class="c1"># shutdown the node in the ray.shutdown call that happens in the atexit</span>
        <span class="c1"># handler. We still spawn a reaper process in case the atexit handler</span>
        <span class="c1"># isn&#39;t called.</span>
        <span class="n">_global_node</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">ray_params</span><span class="o">=</span><span class="n">ray_params</span><span class="p">,</span>
            <span class="n">head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">shutdown_at_exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">spawn_reaper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ray_init_cluster</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># In this case, we are connecting to an existing cluster.</span>
        <span class="k">if</span> <span class="n">num_cpus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_gpus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;When connecting to an existing cluster, num_cpus &quot;</span>
                <span class="s2">&quot;and num_gpus must not be provided.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;When connecting to an existing cluster, &quot;</span>
                <span class="s2">&quot;resources must not be provided.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;When connecting to an existing cluster, &quot;</span>
                <span class="s2">&quot;labels must not be provided.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">object_store_memory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;When connecting to an existing cluster, &quot;</span>
                <span class="s2">&quot;object_store_memory must not be provided.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">_system_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_system_config</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;When connecting to an existing cluster, &quot;</span>
                <span class="s2">&quot;_system_config must not be provided.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">_enable_object_reconstruction</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;When connecting to an existing cluster, &quot;</span>
                <span class="s2">&quot;_enable_object_reconstruction must not be provided.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">_node_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;_node_name cannot be configured when connecting to &quot;</span>
                <span class="s2">&quot;an existing cluster.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># In this case, we only need to connect the node.</span>
        <span class="n">ray_params</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="n">RayParams</span><span class="p">(</span>
            <span class="n">node_ip_address</span><span class="o">=</span><span class="n">_node_ip_address</span><span class="p">,</span>
            <span class="n">gcs_address</span><span class="o">=</span><span class="n">gcs_address</span><span class="p">,</span>
            <span class="n">redis_address</span><span class="o">=</span><span class="n">redis_address</span><span class="p">,</span>
            <span class="n">redis_username</span><span class="o">=</span><span class="n">_redis_username</span><span class="p">,</span>
            <span class="n">redis_password</span><span class="o">=</span><span class="n">_redis_password</span><span class="p">,</span>
            <span class="n">temp_dir</span><span class="o">=</span><span class="n">_temp_dir</span><span class="p">,</span>
            <span class="n">_system_config</span><span class="o">=</span><span class="n">_system_config</span><span class="p">,</span>
            <span class="n">enable_object_reconstruction</span><span class="o">=</span><span class="n">_enable_object_reconstruction</span><span class="p">,</span>
            <span class="n">metrics_export_port</span><span class="o">=</span><span class="n">_metrics_export_port</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_global_node</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                <span class="n">ray_params</span><span class="p">,</span>
                <span class="n">head</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">shutdown_at_exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">spawn_reaper</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">connect_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ConnectionError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">gcs_address</span> <span class="o">==</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">read_ray_address</span><span class="p">(</span><span class="n">_temp_dir</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to connect to the default Ray cluster address at &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gcs_address</span><span class="si">}</span><span class="s2">. This is most likely due to a previous Ray &quot;</span>
                    <span class="s2">&quot;instance that has since crashed. To reset the default &quot;</span>
                    <span class="s2">&quot;address to connect to, run `ray stop` or restart Ray with &quot;</span>
                    <span class="s2">&quot;`ray start`.&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ConnectionError</span>

    <span class="c1"># Log a message to find the Ray address that we connected to and the</span>
    <span class="c1"># dashboard URL.</span>
    <span class="k">if</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_OVERRIDE_DASHBOARD_URL</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">dashboard_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_OVERRIDE_DASHBOARD_URL</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dashboard_url</span> <span class="o">=</span> <span class="n">_global_node</span><span class="o">.</span><span class="n">webui_url</span>
    <span class="c1"># Add http protocol to dashboard URL if it doesn&#39;t</span>
    <span class="c1"># already contain a protocol.</span>
    <span class="k">if</span> <span class="n">dashboard_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">dashboard_url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>
        <span class="n">dashboard_url</span> <span class="o">=</span> <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">dashboard_url</span>

    <span class="c1"># We logged the address before attempting the connection, so we don&#39;t need</span>
    <span class="c1"># to log it again.</span>
    <span class="n">info_str</span> <span class="o">=</span> <span class="s2">&quot;Connected to Ray cluster.&quot;</span>
    <span class="k">if</span> <span class="n">gcs_address</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">info_str</span> <span class="o">=</span> <span class="s2">&quot;Started a local Ray instance.&quot;</span>
    <span class="k">if</span> <span class="n">dashboard_url</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">info_str</span> <span class="o">+</span> <span class="s2">&quot; View the dashboard at </span><span class="si">%s%s%s</span><span class="s2"> </span><span class="si">%s%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="p">,</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span>
            <span class="n">dashboard_url</span><span class="p">,</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info_str</span><span class="p">)</span>

    <span class="n">connect</span><span class="p">(</span>
        <span class="n">_global_node</span><span class="p">,</span>
        <span class="n">_global_node</span><span class="o">.</span><span class="n">session_name</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">driver_mode</span><span class="p">,</span>
        <span class="n">log_to_driver</span><span class="o">=</span><span class="n">log_to_driver</span><span class="p">,</span>
        <span class="n">worker</span><span class="o">=</span><span class="n">global_worker</span><span class="p">,</span>
        <span class="n">driver_object_store_memory</span><span class="o">=</span><span class="n">_driver_object_store_memory</span><span class="p">,</span>
        <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
        <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
        <span class="n">entrypoint</span><span class="o">=</span><span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_entrypoint_name</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">job_config</span> <span class="ow">and</span> <span class="n">job_config</span><span class="o">.</span><span class="n">code_search_path</span><span class="p">:</span>
        <span class="n">global_worker</span><span class="o">.</span><span class="n">set_load_code_from_local</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Because `ray.shutdown()` doesn&#39;t reset this flag, for multiple</span>
        <span class="c1"># sessions in one process, the 2nd `ray.init()` will reuse the</span>
        <span class="c1"># flag of last session. For example:</span>
        <span class="c1">#     ray.init(load_code_from_local=True)</span>
        <span class="c1">#     ray.shutdown()</span>
        <span class="c1">#     ray.init()</span>
        <span class="c1">#     # Here the flag `load_code_from_local` is still True if we</span>
        <span class="c1">#     # doesn&#39;t have this `else` branch.</span>
        <span class="c1">#     ray.shutdown()</span>
        <span class="n">global_worker</span><span class="o">.</span><span class="n">set_load_code_from_local</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">_post_init_hooks</span><span class="p">:</span>
        <span class="n">hook</span><span class="p">()</span>

    <span class="n">node_id</span> <span class="o">=</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_current_node_id</span><span class="p">()</span>
    <span class="n">global_node_address_info</span> <span class="o">=</span> <span class="n">_global_node</span><span class="o">.</span><span class="n">address_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">global_node_address_info</span><span class="p">[</span><span class="s2">&quot;webui_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_remove_protocol_from_url</span><span class="p">(</span><span class="n">dashboard_url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">RayContext</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">global_node_address_info</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node_id</span><span class="o">.</span><span class="n">hex</span><span class="p">()))</span></div>



<span class="c1"># Functions to run as callback after a successful ray init.</span>
<span class="n">_post_init_hooks</span> <span class="o">=</span> <span class="p">[]</span>


<div class="viewcode-block" id="shutdown">
<a class="viewcode-back" href="../../../ray.html#ray.shutdown">[docs]</a>
<span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="n">_exiting_interpreter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Disconnect the worker, and terminate processes started by ray.init().</span>

<span class="sd">    This will automatically run at the end when a Python process that uses Ray</span>
<span class="sd">    exits. It is ok to run this twice in a row. The primary use case for this</span>
<span class="sd">    function is to cleanup state between tests.</span>

<span class="sd">    Note that this will clear any remote function definitions, actor</span>
<span class="sd">    definitions, and existing actors, so if you wish to use any previously</span>
<span class="sd">    defined remote functions or actors after calling ray.shutdown(), then you</span>
<span class="sd">    need to redefine them. If they were defined in an imported module, then you</span>
<span class="sd">    will need to reload the module.</span>

<span class="sd">    Args:</span>
<span class="sd">        _exiting_interpreter: True if this is called by the atexit hook</span>
<span class="sd">            and false otherwise. If we are exiting the interpreter, we will</span>
<span class="sd">            wait a little while to print any extra error messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make sure to clean up compiled dag node if exists.</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">ray.dag.compiled_dag_node</span><span class="w"> </span><span class="kn">import</span> <span class="n">_shutdown_all_compiled_dags</span>

    <span class="n">_shutdown_all_compiled_dags</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">_exiting_interpreter</span> <span class="ow">and</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span><span class="p">:</span>
        <span class="c1"># This is a duration to sleep before shutting down everything in order</span>
        <span class="c1"># to make sure that log messages finish printing.</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">disconnect</span><span class="p">(</span><span class="n">_exiting_interpreter</span><span class="p">)</span>

    <span class="c1"># disconnect internal kv</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">global_worker</span><span class="p">,</span> <span class="s2">&quot;gcs_client&quot;</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">gcs_client</span>
    <span class="n">_internal_kv_reset</span><span class="p">()</span>

    <span class="c1"># We need to destruct the core worker here because after this function,</span>
    <span class="c1"># we will tear down any processes spawned by ray.init() and the background</span>
    <span class="c1"># IO thread in the core worker doesn&#39;t currently handle that gracefully.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">global_worker</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span> <span class="ow">or</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
            <span class="n">global_worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">shutdown_driver</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">core_worker</span>
    <span class="c1"># We need to reset function actor manager to clear the context</span>
    <span class="n">global_worker</span><span class="o">.</span><span class="n">function_actor_manager</span> <span class="o">=</span> <span class="n">FunctionActorManager</span><span class="p">(</span><span class="n">global_worker</span><span class="p">)</span>
    <span class="c1"># Disconnect global state from GCS.</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="c1"># Shut down the Ray processes.</span>
    <span class="k">global</span> <span class="n">_global_node</span>
    <span class="k">if</span> <span class="n">_global_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_global_node</span><span class="o">.</span><span class="n">is_head</span><span class="p">():</span>
            <span class="n">_global_node</span><span class="o">.</span><span class="n">destroy_external_storage</span><span class="p">()</span>
        <span class="n">_global_node</span><span class="o">.</span><span class="n">kill_all_processes</span><span class="p">(</span><span class="n">check_alive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_graceful</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_global_node</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># TODO(rkn): Instead of manually resetting some of the worker fields, we</span>
    <span class="c1"># should simply set &quot;global_worker&quot; to equal &quot;None&quot; or something like that.</span>
    <span class="n">global_worker</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">global_worker</span><span class="o">.</span><span class="n">set_cached_job_id</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>



<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">shutdown</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Define a custom excepthook so that if the driver exits with an exception, we</span>
<span class="c1"># can push that exception to Redis.</span>
<span class="n">normal_excepthook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span>


<span class="k">def</span><span class="w"> </span><span class="nf">custom_excepthook</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">ray.core.generated.common_pb2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">common_pb2</span>

    <span class="c1"># If this is a driver, push the exception to GCS worker table.</span>
    <span class="k">if</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">global_worker</span><span class="p">,</span> <span class="s2">&quot;worker_id&quot;</span><span class="p">):</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">))</span>
        <span class="n">worker_id</span> <span class="o">=</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">worker_id</span>
        <span class="n">worker_type</span> <span class="o">=</span> <span class="n">common_pb2</span><span class="o">.</span><span class="n">DRIVER</span>
        <span class="n">worker_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;exception&quot;</span><span class="p">:</span> <span class="n">error_message</span><span class="p">}</span>

        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_check_connected</span><span class="p">()</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">add_worker</span><span class="p">(</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">worker_type</span><span class="p">,</span> <span class="n">worker_info</span><span class="p">)</span>
    <span class="c1"># Call the normal excepthook.</span>
    <span class="n">normal_excepthook</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>


<span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">custom_excepthook</span>


<span class="k">def</span><span class="w"> </span><span class="nf">print_to_stdstream</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">should_dedup</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;autoscaler&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_err&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">should_dedup</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="n">stderr_deduplicator</span><span class="o">.</span><span class="n">deduplicate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>
        <span class="n">sink</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">should_dedup</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="n">stdout_deduplicator</span><span class="o">.</span><span class="n">deduplicate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>
        <span class="n">sink</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
        <span class="n">print_worker_logs</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="p">)</span>


<span class="c1"># Start time of this process, used for relative time logs.</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">autoscaler_log_fyi_printed</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">filter_autoscaler_events</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given raw log lines from the monitor, return only autoscaler events.</span>

<span class="sd">    For Autoscaler V1:</span>
<span class="sd">        Autoscaler events are denoted by the &quot;:event_summary:&quot; magic token.</span>
<span class="sd">    For Autoscaler V2:</span>
<span class="sd">        Autoscaler events are published from log_monitor.py which read</span>
<span class="sd">        them from the `event_AUTOSCALER.log`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">AUTOSCALER_EVENTS</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">AUTOSCALER_LOG_FYI</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Tip: use `ray status` to view detailed &quot;</span>
        <span class="s2">&quot;cluster status. To disable these &quot;</span>
        <span class="s2">&quot;messages, set RAY_SCHEDULER_EVENTS=0.&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">autoscaler_log_fyi_needed</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">autoscaler_log_fyi_printed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">autoscaler_log_fyi_printed</span><span class="p">:</span>
            <span class="n">autoscaler_log_fyi_printed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">ray.autoscaler.v2.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_autoscaler_v2</span>

    <span class="k">if</span> <span class="n">is_autoscaler_v2</span><span class="p">():</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">ray._private.event.event_logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">filter_event_by_level</span><span class="p">,</span> <span class="n">parse_event</span>

        <span class="k">for</span> <span class="n">event_line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">autoscaler_log_fyi_needed</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">AUTOSCALER_LOG_FYI</span>

            <span class="n">event</span> <span class="o">=</span> <span class="n">parse_event</span><span class="p">(</span><span class="n">event_line</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">filter_event_by_level</span><span class="p">(</span>
                <span class="n">event</span><span class="p">,</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_LOG_TO_DRIVER_EVENT_LEVEL</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">yield</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Print out autoscaler events only, ignoring other messages.</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">LOG_PREFIX_EVENT_SUMMARY</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">autoscaler_log_fyi_needed</span><span class="p">():</span>
                    <span class="k">yield</span> <span class="n">AUTOSCALER_LOG_FYI</span>
                <span class="c1"># The event text immediately follows the &quot;:event_summary:&quot;</span>
                <span class="c1"># magic token.</span>
                <span class="k">yield</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">LOG_PREFIX_EVENT_SUMMARY</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">time_string</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the relative time from the start of this job.</span>

<span class="sd">    For example, 15m30s.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">hours</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">minutes</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">3600</span><span class="p">:</span>
        <span class="n">hours</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">delta</span> <span class="o">-=</span> <span class="mi">3600</span>
    <span class="k">while</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">minutes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">delta</span> <span class="o">-=</span> <span class="mi">60</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hours</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">h&quot;</span>
    <span class="k">if</span> <span class="n">minutes</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">minutes</span><span class="si">}</span><span class="s2">m&quot;</span>
    <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span><span class="si">}</span><span class="s2">s&quot;</span>
    <span class="k">return</span> <span class="n">output</span>


<span class="c1"># When we enter a breakpoint, worker logs are automatically disabled via this.</span>
<span class="n">_worker_logs_enabled</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span><span class="w"> </span><span class="nf">print_worker_logs</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">print_file</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_worker_logs_enabled</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prefix_for</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The PID prefix for this log line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;autoscaler&quot;</span><span class="p">,</span> <span class="s2">&quot;raylet&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;pid=&quot;</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;actor_name&quot;</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;actor_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_name&quot;</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;task_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">message_for</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The printed message of this log line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">LOG_PREFIX_INFO_MESSAGE</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">LOG_PREFIX_INFO_MESSAGE</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">color_for</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The color for this log line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;raylet&quot;</span>
            <span class="ow">and</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">LOG_PREFIX_INFO_MESSAGE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;autoscaler&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Error:&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s2">&quot;Warning:&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RAY_COLOR_PREFIX&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
                <span class="c1"># colorama.Fore.BLUE, # Too dark</span>
                <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">MAGENTA</span><span class="p">,</span>
                <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span><span class="p">,</span>
                <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span>
                <span class="c1"># colorama.Fore.WHITE, # Too light</span>
                <span class="c1"># colorama.Fore.RED,</span>
                <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">LIGHTBLACK_EX</span><span class="p">,</span>
                <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">LIGHTBLUE_EX</span><span class="p">,</span>
                <span class="c1"># colorama.Fore.LIGHTCYAN_EX, # Too light</span>
                <span class="c1"># colorama.Fore.LIGHTGREEN_EX, # Too light</span>
                <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">LIGHTMAGENTA_EX</span><span class="p">,</span>
                <span class="c1"># colorama.Fore.LIGHTWHITE_EX, # Too light</span>
                <span class="c1"># colorama.Fore.LIGHTYELLOW_EX, # Too light</span>
            <span class="p">]</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">CYAN</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;autoscaler&quot;</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="s2">&quot;autoscaler +</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_string</span><span class="p">())</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">filter_autoscaler_events</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pid&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">)</span>
    <span class="n">ip_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, ip=</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">RAY_TQDM_MAGIC</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">process_tqdm</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hide_tqdm</span><span class="p">()</span>
            <span class="c1"># If RAY_COLOR_PREFIX=0, do not wrap with any color codes</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RAY_COLOR_PREFIX&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                <span class="n">color_pre</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">color_post</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color_pre</span> <span class="o">=</span> <span class="n">color_for</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">color_post</span> <span class="o">=</span> <span class="n">colorama</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span>

            <span class="k">if</span> <span class="n">ignore_prefix</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message_for</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">file</span><span class="o">=</span><span class="n">print_file</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">color_pre</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">prefix_for</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}{</span><span class="n">pid</span><span class="si">}{</span><span class="n">ip_prefix</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">color_post</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message_for</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">file</span><span class="o">=</span><span class="n">print_file</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># Restore once at end of batch to avoid excess hiding/unhiding of tqdm.</span>
    <span class="n">restore_tqdm</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">process_tqdm</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Experimental distributed tqdm: see ray.experimental.tqdm_ray.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">tqdm_ray</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">process_state_update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">log_once</span><span class="p">(</span><span class="s2">&quot;tqdm_corruption&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[tqdm_ray] Failed to decode </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">, this may be due to &quot;</span>
                <span class="s2">&quot;logging too fast. This warning will not be printed again.&quot;</span>
            <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">hide_tqdm</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hide distributed tqdm bars temporarily to avoid conflicts with other logs.&quot;&quot;&quot;</span>
    <span class="n">tqdm_ray</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">hide_bars</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">restore_tqdm</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Undo hide_tqdm().&quot;&quot;&quot;</span>
    <span class="n">tqdm_ray</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">unhide_bars</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">listen_error_messages</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">threads_stopped</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Listen to error messages in the background on the driver.</span>

<span class="sd">    This runs in a separate thread on the driver and pushes (error, time)</span>
<span class="sd">    tuples to be published.</span>

<span class="sd">    Args:</span>
<span class="sd">        worker: The worker class that this thread belongs to.</span>
<span class="sd">        threads_stopped (threading.Event): A threading event used to signal to</span>
<span class="sd">            the thread that it should exit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: we should just subscribe to the errors for this specific job.</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">gcs_error_subscriber</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_internal_kv_initialized</span><span class="p">():</span>
            <span class="c1"># Get any autoscaler errors that occurred before the call to</span>
            <span class="c1"># subscribe.</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">_internal_kv_get</span><span class="p">(</span><span class="n">ray_constants</span><span class="o">.</span><span class="n">DEBUG_AUTOSCALING_ERROR</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error_message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Exit if received a signal that the thread should stop.</span>
            <span class="k">if</span> <span class="n">threads_stopped</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">error_data</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">gcs_error_subscriber</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">error_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">error_data</span><span class="p">[</span><span class="s2">&quot;job_id&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">error_data</span><span class="p">[</span><span class="s2">&quot;job_id&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">worker</span><span class="o">.</span><span class="n">current_job_id</span><span class="o">.</span><span class="n">binary</span><span class="p">(),</span>
                <span class="n">JobID</span><span class="o">.</span><span class="n">nil</span><span class="p">()</span><span class="o">.</span><span class="n">binary</span><span class="p">(),</span>
            <span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_data</span><span class="p">[</span><span class="s2">&quot;error_message&quot;</span><span class="p">]</span>
            <span class="n">print_to_stdstream</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">error_message</span><span class="p">],</span>
                    <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="s2">&quot;raylet&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;is_err&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">ignore_prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ConnectionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;listen_error_messages: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="is_initialized">
<a class="viewcode-back" href="../../../ray.html#ray.is_initialized">[docs]</a>
<span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">is_initialized</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if ray.init has been called yet.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if ray.init has already been called and false otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">global_worker</span><span class="o">.</span><span class="n">connected</span></div>



<span class="c1"># TODO(hjiang): Add cgroup path along with [enable_resource_isolation].</span>
<span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span>
    <span class="n">node</span><span class="p">,</span>
    <span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="n">WORKER_MODE</span><span class="p">,</span>
    <span class="n">log_to_driver</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">worker</span><span class="o">=</span><span class="n">global_worker</span><span class="p">,</span>
    <span class="n">driver_object_store_memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">job_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">runtime_env_hash</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">startup_token</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">ray_debugger_external</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">worker_launch_time_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">worker_launched_time_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">debug_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">enable_resource_isolation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Connect this worker to the raylet, to Plasma, and to GCS.</span>

<span class="sd">    Args:</span>
<span class="sd">        node (ray._private.node.Node): The node to connect.</span>
<span class="sd">        session_name: The session name (cluster id) of this cluster.</span>
<span class="sd">        mode: The mode of the worker. One of SCRIPT_MODE, WORKER_MODE, and LOCAL_MODE.</span>
<span class="sd">        log_to_driver: If true, then output from all of the worker</span>
<span class="sd">            processes on all nodes will be directed to the driver.</span>
<span class="sd">        worker: The ray.Worker instance.</span>
<span class="sd">        driver_object_store_memory: Deprecated.</span>
<span class="sd">        job_id: The ID of job. If it&#39;s None, then we will generate one.</span>
<span class="sd">        namespace: Namespace to use.</span>
<span class="sd">        job_config (ray.job_config.JobConfig): The job configuration.</span>
<span class="sd">        runtime_env_hash: The hash of the runtime env for this worker.</span>
<span class="sd">        startup_token: The startup token of the process assigned to</span>
<span class="sd">            it during startup as a command line argument.</span>
<span class="sd">        ray_debugger_external: If True, make the debugger external to the</span>
<span class="sd">            node this worker is running on.</span>
<span class="sd">        entrypoint: The name of the entrypoint script. Ignored if the</span>
<span class="sd">            mode != SCRIPT_MODE</span>
<span class="sd">        worker_launch_time_ms: The time when the worker process for this worker</span>
<span class="sd">            is launched. If the worker is not launched by raylet (e.g.,</span>
<span class="sd">            driver), this must be -1 (default value).</span>
<span class="sd">        worker_launched_time_ms: The time when the worker process for this worker</span>
<span class="sd">            finshes launching. If the worker is not launched by raylet (e.g.,</span>
<span class="sd">            driver), this must be -1 (default value).</span>
<span class="sd">        debug_source: Source information for `CoreWorker`, used for debugging and informational purpose, rather than functional purpose.</span>
<span class="sd">        enable_resource_isolation: If true, core worker enables resource isolation by adding itself into appropriate cgroup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Do some basic checking to make sure we didn&#39;t call ray.init twice.</span>
    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Perhaps you called ray.init twice by accident?&quot;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">worker</span><span class="o">.</span><span class="n">connected</span><span class="p">,</span> <span class="n">error_message</span>

    <span class="c1"># Enable nice stack traces on SIGSEGV etc.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">faulthandler</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">():</span>
            <span class="n">faulthandler</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">all_threads</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">io</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># ignore</span>

    <span class="n">worker</span><span class="o">.</span><span class="n">gcs_client</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_gcs_client</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">worker</span><span class="o">.</span><span class="n">gcs_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">_initialize_internal_kv</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">gcs_client</span><span class="p">)</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_initialize_global_state</span><span class="p">(</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">GcsClientOptions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">node</span><span class="o">.</span><span class="n">gcs_address</span><span class="p">,</span>
            <span class="n">node</span><span class="o">.</span><span class="n">cluster_id</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span>
            <span class="n">allow_cluster_id_nil</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fetch_cluster_id_if_nil</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Initialize some fields.</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="n">WORKER_MODE</span><span class="p">,</span> <span class="n">RESTORE_WORKER_MODE</span><span class="p">,</span> <span class="n">SPILL_WORKER_MODE</span><span class="p">):</span>
        <span class="c1"># We should not specify the job_id if it&#39;s `WORKER_MODE`.</span>
        <span class="k">assert</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">nil</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This is the code path of driver mode.</span>
        <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">next_job_id</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">SCRIPT_MODE</span> <span class="ow">and</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
        <span class="n">process_name</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">WORKER_PROCESS_TYPE_IDLE_WORKER</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="n">SPILL_WORKER_MODE</span><span class="p">:</span>
            <span class="n">process_name</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">WORKER_PROCESS_TYPE_SPILL_WORKER_IDLE</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="ow">is</span> <span class="n">RESTORE_WORKER_MODE</span><span class="p">:</span>
            <span class="n">process_name</span> <span class="o">=</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">WORKER_PROCESS_TYPE_RESTORE_WORKER_IDLE</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">setproctitle</span><span class="p">(</span><span class="n">process_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">JobID</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The type of given job id must be JobID.&quot;</span><span class="p">)</span>

    <span class="c1"># All workers start out as non-actors. A worker can be turned into an actor</span>
    <span class="c1"># after it is created.</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

    <span class="c1"># For driver&#39;s check that the version information matches the version</span>
    <span class="c1"># information that the Ray cluster was started with.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">check_version_info</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">WORKER_MODE</span><span class="p">:</span>
            <span class="n">traceback_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">publish_error_to_driver</span><span class="p">(</span>
                <span class="n">ray_constants</span><span class="o">.</span><span class="n">VERSION_MISMATCH_PUSH_ERROR</span><span class="p">,</span>
                <span class="n">traceback_str</span><span class="p">,</span>
                <span class="n">gcs_client</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">gcs_client</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">driver_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">interactive_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">__main__</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">main</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s2">&quot;__file__&quot;</span><span class="p">):</span>
            <span class="n">driver_name</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="vm">__file__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interactive_mode</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">driver_name</span> <span class="o">=</span> <span class="s2">&quot;INTERACTIVE MODE&quot;</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid worker mode. Expected DRIVER, WORKER or LOCAL.&quot;</span><span class="p">)</span>

    <span class="n">gcs_options</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">GcsClientOptions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">node</span><span class="o">.</span><span class="n">gcs_address</span><span class="p">,</span>
        <span class="n">node</span><span class="o">.</span><span class="n">cluster_id</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span>
        <span class="n">allow_cluster_id_nil</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">fetch_cluster_id_if_nil</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">job_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">job_config</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">job_config</span><span class="o">.</span><span class="n">JobConfig</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">validate_namespace</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>

        <span class="c1"># The namespace field of job config may have already been set in code</span>
        <span class="c1"># paths such as the client.</span>
        <span class="n">job_config</span><span class="o">.</span><span class="n">set_ray_namespace</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>

    <span class="c1"># Make sure breakpoint() in the user&#39;s code will</span>
    <span class="c1"># invoke the Ray debugger if we are in a worker or actor process</span>
    <span class="c1"># (but not on the driver).</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">WORKER_MODE</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONBREAKPOINT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ray.util.rpdb.set_trace&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Add hook to suppress worker logs during breakpoint.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONBREAKPOINT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ray.util.rpdb._driver_set_trace&quot;</span>

    <span class="n">worker</span><span class="o">.</span><span class="n">ray_debugger_external</span> <span class="o">=</span> <span class="n">ray_debugger_external</span>

    <span class="c1"># If it&#39;s a driver and it&#39;s not coming from ray client, we&#39;ll prepare the</span>
    <span class="c1"># environment here. If it&#39;s ray client, the environment will be prepared</span>
    <span class="c1"># at the server side.</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">_client_job</span> <span class="ow">and</span> <span class="n">job_config</span><span class="o">.</span><span class="n">runtime_env</span><span class="p">:</span>
        <span class="n">scratch_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_runtime_env_dir_path</span><span class="p">()</span>
        <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">job_config</span><span class="o">.</span><span class="n">runtime_env</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">upload_py_modules_if_needed</span><span class="p">(</span>
            <span class="n">runtime_env</span><span class="p">,</span> <span class="n">scratch_dir</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span>
        <span class="p">)</span>
        <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">upload_working_dir_if_needed</span><span class="p">(</span>
            <span class="n">runtime_env</span><span class="p">,</span> <span class="n">scratch_dir</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span>
        <span class="p">)</span>
        <span class="n">runtime_env</span> <span class="o">=</span> <span class="n">upload_worker_process_setup_hook_if_needed</span><span class="p">(</span>
            <span class="n">runtime_env</span><span class="p">,</span>
            <span class="n">worker</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Remove excludes, it isn&#39;t relevant after the upload step.</span>
        <span class="n">runtime_env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;excludes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">job_config</span><span class="o">.</span><span class="n">set_runtime_env</span><span class="p">(</span><span class="n">runtime_env</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span><span class="p">:</span>
        <span class="c1"># Add the directory containing the script that is running to the Python</span>
        <span class="c1"># paths of the workers. Also add the current directory. Note that this</span>
        <span class="c1"># assumes that the directory structures on the machines in the clusters</span>
        <span class="c1"># are the same.</span>
        <span class="c1"># When using an interactive shell, there is no script directory.</span>
        <span class="c1"># We also want to skip adding script directory when running from dashboard.</span>
        <span class="n">code_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">interactive_mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">namespace</span> <span class="ow">and</span> <span class="n">namespace</span> <span class="o">==</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">RAY_INTERNAL_DASHBOARD_NAMESPACE</span>
        <span class="p">):</span>
            <span class="n">script_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="c1"># If driver&#39;s sys.path doesn&#39;t include the script directory</span>
            <span class="c1"># (e.g driver is started via `python -m`,</span>
            <span class="c1"># see https://peps.python.org/pep-0338/),</span>
            <span class="c1"># then we shouldn&#39;t add it to the workers.</span>
            <span class="k">if</span> <span class="n">script_directory</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="n">code_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">script_directory</span><span class="p">)</span>
        <span class="c1"># In client mode, if we use runtime envs with &quot;working_dir&quot;, then</span>
        <span class="c1"># it&#39;ll be handled automatically.  Otherwise, add the current dir.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">_client_job</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">_runtime_env_has_working_dir</span><span class="p">():</span>
            <span class="n">current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
            <span class="n">code_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_paths</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">_py_driver_sys_path</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">code_paths</span><span class="p">)</span>

    <span class="n">serialized_job_config</span> <span class="o">=</span> <span class="n">job_config</span><span class="o">.</span><span class="n">_serialize</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">should_redirect_logs</span><span class="p">():</span>
        <span class="c1"># Logging to stderr, so give core worker empty logs directory.</span>
        <span class="n">logs_dir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logs_dir</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_logs_dir_path</span><span class="p">()</span>

    <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">CoreWorker</span><span class="p">(</span>
        <span class="n">mode</span><span class="p">,</span>
        <span class="n">node</span><span class="o">.</span><span class="n">plasma_store_socket_name</span><span class="p">,</span>
        <span class="n">node</span><span class="o">.</span><span class="n">raylet_socket_name</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">,</span>
        <span class="n">gcs_options</span><span class="p">,</span>
        <span class="n">logs_dir</span><span class="p">,</span>
        <span class="n">node</span><span class="o">.</span><span class="n">node_ip_address</span><span class="p">,</span>
        <span class="n">node</span><span class="o">.</span><span class="n">node_manager_port</span><span class="p">,</span>
        <span class="n">node</span><span class="o">.</span><span class="n">raylet_ip_address</span><span class="p">,</span>
        <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LOCAL_MODE</span><span class="p">),</span>
        <span class="n">driver_name</span><span class="p">,</span>
        <span class="n">serialized_job_config</span><span class="p">,</span>
        <span class="n">node</span><span class="o">.</span><span class="n">metrics_agent_port</span><span class="p">,</span>
        <span class="n">runtime_env_hash</span><span class="p">,</span>
        <span class="n">startup_token</span><span class="p">,</span>
        <span class="n">session_name</span><span class="p">,</span>
        <span class="n">node</span><span class="o">.</span><span class="n">cluster_id</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span>
        <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">SCRIPT_MODE</span> <span class="k">else</span> <span class="n">entrypoint</span><span class="p">,</span>
        <span class="n">worker_launch_time_ms</span><span class="p">,</span>
        <span class="n">worker_launched_time_ms</span><span class="p">,</span>
        <span class="n">debug_source</span><span class="p">,</span>
        <span class="n">enable_resource_isolation</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span><span class="p">:</span>
        <span class="n">worker_id</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">worker_id</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">gcs_error_subscriber</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">GcsErrorSubscriber</span><span class="p">(</span>
            <span class="n">worker_id</span><span class="o">=</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">gcs_client</span><span class="o">.</span><span class="n">address</span>
        <span class="p">)</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">gcs_log_subscriber</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">GcsLogSubscriber</span><span class="p">(</span>
            <span class="n">worker_id</span><span class="o">=</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">gcs_client</span><span class="o">.</span><span class="n">address</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">driver_object_store_memory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;`driver_object_store_memory` is deprecated&quot;</span>
            <span class="s2">&quot; and will be removed in the future.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># If this is a driver running in SCRIPT_MODE, start a thread to print error</span>
    <span class="c1"># messages asynchronously in the background. Ideally the scheduler would</span>
    <span class="c1"># push messages to the driver&#39;s worker service, but we ran into bugs when</span>
    <span class="c1"># trying to properly shutdown the driver&#39;s worker service, so we are</span>
    <span class="c1"># temporarily using this implementation which constantly queries the</span>
    <span class="c1"># scheduler for new error messages.</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SCRIPT_MODE</span><span class="p">:</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">listener_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">listen_error_messages</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ray_listen_error_messages&quot;</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">threads_stopped</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">listener_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">listener_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="c1"># If the job&#39;s logging config is set, don&#39;t add the prefix</span>
        <span class="c1"># (task/actor&#39;s name and its PID) to the logs.</span>
        <span class="n">ignore_prefix</span> <span class="o">=</span> <span class="n">global_worker</span><span class="o">.</span><span class="n">job_logging_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">log_to_driver</span><span class="p">:</span>
            <span class="n">global_worker_stdstream_dispatcher</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span>
                <span class="s2">&quot;ray_print_logs&quot;</span><span class="p">,</span>
                <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">print_to_stdstream</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="o">=</span><span class="n">ignore_prefix</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">logger_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">print_logs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ray_print_logs&quot;</span>
            <span class="p">)</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">logger_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">logger_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Setup tracing here</span>
    <span class="n">tracing_hook_val</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">gcs_client</span><span class="o">.</span><span class="n">internal_kv_get</span><span class="p">(</span>
        <span class="sa">b</span><span class="s2">&quot;tracing_startup_hook&quot;</span><span class="p">,</span> <span class="n">ray_constants</span><span class="o">.</span><span class="n">KV_NAMESPACE_TRACING</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">tracing_hook_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">tracing</span><span class="o">.</span><span class="n">tracing_helper</span><span class="o">.</span><span class="n">_enable_tracing</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ray</span><span class="p">,</span> <span class="s2">&quot;__traced__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">_setup_tracing</span> <span class="o">=</span> <span class="n">_import_from_string</span><span class="p">(</span><span class="n">tracing_hook_val</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="n">_setup_tracing</span><span class="p">()</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">__traced__</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Mark the worker as connected.</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">set_is_connected</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">disconnect</span><span class="p">(</span><span class="n">exiting_interpreter</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Disconnect this worker from the raylet and object store.&quot;&quot;&quot;</span>
    <span class="c1"># Reset the list of cached remote functions and actors so that if more</span>
    <span class="c1"># remote functions or actors are defined and then connect is called again,</span>
    <span class="c1"># the remote functions will be exported. This is mostly relevant for the</span>
    <span class="c1"># tests.</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
        <span class="c1"># Shutdown all of the threads that we&#39;ve started. TODO(rkn): This</span>
        <span class="c1"># should be handled cleanly in the worker object&#39;s destructor and not</span>
        <span class="c1"># in this disconnect method.</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">threads_stopped</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;gcs_error_subscriber&quot;</span><span class="p">):</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">gcs_error_subscriber</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;gcs_log_subscriber&quot;</span><span class="p">):</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">gcs_log_subscriber</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;listener_thread&quot;</span><span class="p">):</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">listener_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;logger_thread&quot;</span><span class="p">):</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">logger_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">threads_stopped</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Ignore the prefix if the logging config is set.</span>
        <span class="n">ignore_prefix</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">job_logging_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">leftover</span> <span class="ow">in</span> <span class="n">stdout_deduplicator</span><span class="o">.</span><span class="n">flush</span><span class="p">():</span>
            <span class="n">print_worker_logs</span><span class="p">(</span><span class="n">leftover</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">leftover</span> <span class="ow">in</span> <span class="n">stderr_deduplicator</span><span class="o">.</span><span class="n">flush</span><span class="p">():</span>
            <span class="n">print_worker_logs</span><span class="p">(</span><span class="n">leftover</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="p">)</span>
        <span class="n">global_worker_stdstream_dispatcher</span><span class="o">.</span><span class="n">remove_handler</span><span class="p">(</span><span class="s2">&quot;ray_print_logs&quot;</span><span class="p">)</span>

    <span class="n">worker</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Disconnect the worker from the node.</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">serialization_context_map</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ray_actor</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">actor</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">ray_actor</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># This can occur during program termination</span>
    <span class="k">if</span> <span class="n">ray_actor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray_actor</span><span class="o">.</span><span class="n">_ActorClassMethodMetadata</span><span class="o">.</span><span class="n">reset_cache</span><span class="p">()</span>

    <span class="c1"># Mark the worker as disconnected.</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">set_is_connected</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_changeproctitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">next_title</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_mode</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">setproctitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_mode</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">LOCAL_MODE</span><span class="p">:</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">setproctitle</span><span class="p">(</span><span class="n">next_title</span><span class="p">)</span>


<span class="nd">@DeveloperAPI</span>
<span class="k">def</span><span class="w"> </span><span class="nf">show_in_dashboard</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display message in dashboard.</span>

<span class="sd">    Display message for the current task or actor in the dashboard.</span>
<span class="sd">    For example, this can be used to display the status of a long-running</span>
<span class="sd">    computation.</span>

<span class="sd">    Args:</span>
<span class="sd">        message: Message to be displayed.</span>
<span class="sd">        key: The key name for the message. Multiple message under</span>
<span class="sd">            different keys will be displayed at the same time. Messages</span>
<span class="sd">            under the same key will be overridden.</span>
<span class="sd">        dtype: The type of message for rendering. One of the</span>
<span class="sd">            following: text, html.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="n">acceptable_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">acceptable_dtypes</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;dtype accepts only: </span><span class="si">{</span><span class="n">acceptable_dtypes</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">message_wrapped</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">dtype</span><span class="p">}</span>
    <span class="n">message_encoded</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message_wrapped</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

    <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">set_webui_display</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">message_encoded</span><span class="p">)</span>


<span class="c1"># Global variable to make sure we only send out the warning once.</span>
<span class="n">blocking_get_inside_async_warned</span> <span class="o">=</span> <span class="kc">False</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
    <span class="n">object_refs</span><span class="p">:</span> <span class="s2">&quot;Sequence[ObjectRef[Any]]&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
    <span class="n">object_refs</span><span class="p">:</span> <span class="s2">&quot;Sequence[ObjectRef[R]]&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">R</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">object_refs</span><span class="p">:</span> <span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
    <span class="n">object_refs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">CompiledDAGRef</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">object_refs</span><span class="p">:</span> <span class="n">CompiledDAGRef</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="o">...</span>


<div class="viewcode-block" id="get">
<a class="viewcode-back" href="../../../ray.html#ray.get">[docs]</a>
<span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
    <span class="n">object_refs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="s2">&quot;ObjectRef[Any]&quot;</span><span class="p">,</span>
        <span class="n">Sequence</span><span class="p">[</span><span class="s2">&quot;ObjectRef[Any]&quot;</span><span class="p">],</span>
        <span class="n">CompiledDAGRef</span><span class="p">,</span>
        <span class="n">Sequence</span><span class="p">[</span><span class="n">CompiledDAGRef</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a remote object or a list of remote objects from the object store.</span>

<span class="sd">    This method blocks until the object corresponding to the object ref is</span>
<span class="sd">    available in the local object store. If this object is not in the local</span>
<span class="sd">    object store, it will be shipped from an object store that has it (once the</span>
<span class="sd">    object has been created). If object_refs is a list, then the objects</span>
<span class="sd">    corresponding to each object in the list will be returned.</span>

<span class="sd">    Ordering for an input list of object refs is preserved for each object</span>
<span class="sd">    returned. That is, if an object ref to A precedes an object ref to B in the</span>
<span class="sd">    input list, then A will precede B in the returned list.</span>

<span class="sd">    This method will issue a warning if it&#39;s running inside async context,</span>
<span class="sd">    you can use ``await object_ref`` instead of ``ray.get(object_ref)``. For</span>
<span class="sd">    a list of object refs, you can use ``await asyncio.gather(*object_refs)``.</span>

<span class="sd">    Passing :class:`~ObjectRefGenerator` is not allowed.</span>

<span class="sd">    Related patterns and anti-patterns:</span>

<span class="sd">    - :doc:`/ray-core/patterns/ray-get-loop`</span>
<span class="sd">    - :doc:`/ray-core/patterns/unnecessary-ray-get`</span>
<span class="sd">    - :doc:`/ray-core/patterns/ray-get-submission-order`</span>
<span class="sd">    - :doc:`/ray-core/patterns/ray-get-too-many-objects`</span>


<span class="sd">    Args:</span>
<span class="sd">        object_refs: Object ref of the object to get or a list of object refs</span>
<span class="sd">            to get.</span>
<span class="sd">        timeout (Optional[float]): The maximum amount of time in seconds to</span>
<span class="sd">            wait before returning. Set this to None will block until the</span>
<span class="sd">            corresponding object becomes available. Setting ``timeout=0`` will</span>
<span class="sd">            return the object immediately if it&#39;s available, else raise</span>
<span class="sd">            GetTimeoutError in accordance with the above docstring.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A Python object or a list of Python objects.</span>

<span class="sd">    Raises:</span>
<span class="sd">        GetTimeoutError: A GetTimeoutError is raised if a timeout is set and</span>
<span class="sd">            the get takes longer than timeout to return.</span>
<span class="sd">        Exception: An exception is raised immediately if any task that created</span>
<span class="sd">            the object or that created one of the objects raised an exception,</span>
<span class="sd">            without waiting for the remaining ones to finish.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">current_actor_is_asyncio</span><span class="p">():</span>
        <span class="k">global</span> <span class="n">blocking_get_inside_async_warned</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_get_inside_async_warned</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Using blocking ray.get inside async actor. &quot;</span>
                <span class="s2">&quot;This blocks the event loop. Please use `await` &quot;</span>
                <span class="s2">&quot;on object ref with asyncio.gather if you want to &quot;</span>
                <span class="s2">&quot;yield execution to the event loop instead.&quot;</span>
            <span class="p">)</span>
            <span class="n">blocking_get_inside_async_warned</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">with</span> <span class="n">profiling</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="s2">&quot;ray.get&quot;</span><span class="p">):</span>
        <span class="c1"># TODO(sang): Should make ObjectRefGenerator</span>
        <span class="c1"># compatible to ray.get for dataset.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_refs</span><span class="p">,</span> <span class="n">ObjectRefGenerator</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">object_refs</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_refs</span><span class="p">,</span> <span class="n">CompiledDAGRef</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">object_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_refs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">all_compiled_dag_refs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">any_compiled_dag_refs</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">object_ref</span> <span class="ow">in</span> <span class="n">object_refs</span><span class="p">:</span>
                <span class="n">is_dag_ref</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_ref</span><span class="p">,</span> <span class="n">CompiledDAGRef</span><span class="p">)</span>
                <span class="n">all_compiled_dag_refs</span> <span class="o">=</span> <span class="n">all_compiled_dag_refs</span> <span class="ow">and</span> <span class="n">is_dag_ref</span>
                <span class="n">any_compiled_dag_refs</span> <span class="o">=</span> <span class="n">any_compiled_dag_refs</span> <span class="ow">or</span> <span class="n">is_dag_ref</span>
            <span class="k">if</span> <span class="n">all_compiled_dag_refs</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">object_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span> <span class="k">for</span> <span class="n">object_ref</span> <span class="ow">in</span> <span class="n">object_refs</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">any_compiled_dag_refs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid type of object refs. &#39;object_refs&#39; must be a list of &quot;</span>
                    <span class="s2">&quot;CompiledDAGRefs if there is any CompiledDAGRef within it. &quot;</span>
                <span class="p">)</span>

        <span class="n">is_individual_id</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_refs</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_individual_id</span><span class="p">:</span>
            <span class="n">object_refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">object_refs</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_refs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid type of object refs, </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">object_refs</span><span class="p">)</span><span class="si">}</span><span class="s2">, is given. &quot;</span>
                <span class="s2">&quot;&#39;object_refs&#39; must either be an ObjectRef or a list of ObjectRefs. &quot;</span>
            <span class="p">)</span>

        <span class="c1"># TODO(ujvl): Consider how to allow user to retrieve the ready objects.</span>
        <span class="n">values</span><span class="p">,</span> <span class="n">debugger_breakpoint</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">get_objects</span><span class="p">(</span><span class="n">object_refs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">RayError</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ObjectLostError</span><span class="p">):</span>
                    <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">dump_object_store_memory_usage</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">RayTaskError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">value</span><span class="o">.</span><span class="n">as_instanceof_cause</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">is_individual_id</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">debugger_breakpoint</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>
            <span class="n">rdb</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">_connect_ray_pdb</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">patch_stdstreams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">quiet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">breakpoint_uuid</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">debugger_breakpoint</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="n">debugger_breakpoint</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">debugger_external</span><span class="o">=</span><span class="n">worker</span><span class="o">.</span><span class="n">ray_debugger_external</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">(</span><span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values</span></div>



<div class="viewcode-block" id="put">
<a class="viewcode-back" href="../../../ray.html#ray.put">[docs]</a>
<span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">_owner</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ray.actor.ActorHandle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ray.ObjectRef&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store an object in the object store.</span>

<span class="sd">    The object may not be evicted while a reference to the returned ID exists.</span>

<span class="sd">    Related patterns and anti-patterns:</span>

<span class="sd">    - :doc:`/ray-core/patterns/return-ray-put`</span>
<span class="sd">    - :doc:`/ray-core/patterns/pass-large-arg-by-value`</span>
<span class="sd">    - :doc:`/ray-core/patterns/closure-capture-large-objects`</span>

<span class="sd">    Args:</span>
<span class="sd">        value: The Python object to be stored.</span>
<span class="sd">        _owner [Experimental]: The actor that should own this object. This</span>
<span class="sd">            allows creating objects with lifetimes decoupled from that of the</span>
<span class="sd">            creating process. The owner actor must be passed a reference to the</span>
<span class="sd">            object prior to the object creator exiting, otherwise the reference</span>
<span class="sd">            will still be lost. *Note that this argument is an experimental API</span>
<span class="sd">            and should be avoided if possible.*</span>

<span class="sd">    Returns:</span>
<span class="sd">        The object ref assigned to this value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">_owner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">serialize_owner_address</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_owner</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ActorHandle</span><span class="p">):</span>
        <span class="c1"># Ensure `ray._private.state.state.global_state_accessor` is not None</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_check_connected</span><span class="p">()</span>
        <span class="n">serialize_owner_address</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">_get_actor_serialized_owner_address_or_none</span><span class="p">(</span>
                <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">global_state_accessor</span><span class="o">.</span><span class="n">get_actor_info</span><span class="p">(</span>
                    <span class="n">_owner</span><span class="o">.</span><span class="n">_actor_id</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">serialize_owner_address</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_owner</span><span class="si">}</span><span class="s2"> is not alive, it&#39;s worker_id is empty!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expect an `ray.actor.ActorHandle`, but got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">_owner</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">profiling</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="s2">&quot;ray.put&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">object_ref</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">owner_address</span><span class="o">=</span><span class="n">serialize_owner_address</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectStoreFullError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Put failed since the value was either too large or the &quot;</span>
                <span class="s2">&quot;store was full of pinned objects.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">object_ref</span></div>



<span class="c1"># Global variable to make sure we only send out the warning once.</span>
<span class="n">blocking_wait_inside_async_warned</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="wait">
<a class="viewcode-back" href="../../../ray.html#ray.wait">[docs]</a>
<span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">wait</span><span class="p">(</span>
    <span class="n">ray_waitables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ObjectRef</span><span class="p">,</span> <span class="n">ObjectRefGenerator</span><span class="p">]],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">num_returns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fetch_local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ObjectRef</span><span class="p">,</span> <span class="n">ObjectRefGenerator</span><span class="p">]],</span>
    <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ObjectRef</span><span class="p">,</span> <span class="n">ObjectRefGenerator</span><span class="p">]],</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a list of IDs that are ready and a list of IDs that are not.</span>

<span class="sd">    If timeout is set, the function returns either when the requested number of</span>
<span class="sd">    IDs are ready or when the timeout is reached, whichever occurs first. If it</span>
<span class="sd">    is not set, the function simply waits until that number of objects is ready</span>
<span class="sd">    and returns that exact number of object refs.</span>

<span class="sd">    `ray_waitables` is a list of :class:`~ray.ObjectRef` and</span>
<span class="sd">    :class:`~ray.ObjectRefGenerator`.</span>

<span class="sd">    The method returns two lists, ready and unready `ray_waitables`.</span>

<span class="sd">    ObjectRef:</span>
<span class="sd">        object refs that correspond to objects that are available</span>
<span class="sd">        in the object store are in the first list.</span>
<span class="sd">        The rest of the object refs are in the second list.</span>

<span class="sd">    ObjectRefGenerator:</span>
<span class="sd">            Generators whose next reference (that will be obtained</span>
<span class="sd">            via `next(generator)`) has a corresponding object available</span>
<span class="sd">            in the object store are in the first list.</span>
<span class="sd">            All other generators are placed in the second list.</span>

<span class="sd">    Ordering of the input list of ray_waitables is preserved. That is, if A</span>
<span class="sd">    precedes B in the input list, and both are in the ready list, then A will</span>
<span class="sd">    precede B in the ready list. This also holds true if A and B are both in</span>
<span class="sd">    the remaining list.</span>

<span class="sd">    This method will issue a warning if it&#39;s running inside an async context.</span>
<span class="sd">    Instead of ``ray.wait(ray_waitables)``, you can use</span>
<span class="sd">    ``await asyncio.wait(ray_waitables)``.</span>

<span class="sd">    Related patterns and anti-patterns:</span>

<span class="sd">    - :doc:`/ray-core/patterns/limit-pending-tasks`</span>
<span class="sd">    - :doc:`/ray-core/patterns/ray-get-submission-order`</span>

<span class="sd">    Args:</span>
<span class="sd">        ray_waitables: List of :class:`~ObjectRef` or</span>
<span class="sd">            :class:`~ObjectRefGenerator` for objects that may or may</span>
<span class="sd">            not be ready. Note that these must be unique.</span>
<span class="sd">        num_returns: The number of ray_waitables that should be returned.</span>
<span class="sd">        timeout: The maximum amount of time in seconds to wait before</span>
<span class="sd">            returning.</span>
<span class="sd">        fetch_local: If True, wait for the object to be downloaded onto</span>
<span class="sd">            the local node before returning it as ready. If the `ray_waitable`</span>
<span class="sd">            is a generator, it will wait until the next object in the generator</span>
<span class="sd">            is downloaed. If False, ray.wait() will not trigger fetching of</span>
<span class="sd">            objects to the local node and will return immediately once the</span>
<span class="sd">            object is available anywhere in the cluster.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of object refs that are ready and a list of the remaining object</span>
<span class="sd">        IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;core_worker&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">current_actor_is_asyncio</span><span class="p">()</span>
        <span class="ow">and</span> <span class="n">timeout</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="k">global</span> <span class="n">blocking_wait_inside_async_warned</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking_wait_inside_async_warned</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Using blocking ray.wait inside async method. &quot;</span>
                <span class="s2">&quot;This blocks the event loop. Please use `await` &quot;</span>
                <span class="s2">&quot;on object ref with asyncio.wait. &quot;</span>
            <span class="p">)</span>
            <span class="n">blocking_wait_inside_async_warned</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ray_waitables</span><span class="p">,</span> <span class="n">ObjectRef</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">ray_waitables</span><span class="p">,</span> <span class="n">ObjectRefGenerator</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;wait() expected a list of ray.ObjectRef or ray.ObjectRefGenerator&quot;</span>
            <span class="s2">&quot;, got a single ray.ObjectRef or ray.ObjectRefGenerator &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ray_waitables</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ray_waitables</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;wait() expected a list of ray.ObjectRef or &quot;</span>
            <span class="s2">&quot;ray.ObjectRefGenerator, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ray_waitables</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The &#39;timeout&#39; argument must be nonnegative. &quot;</span> <span class="sa">f</span><span class="s2">&quot;Received </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">ray_waitable</span> <span class="ow">in</span> <span class="n">ray_waitables</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ray_waitable</span><span class="p">,</span> <span class="n">ObjectRef</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">ray_waitable</span><span class="p">,</span> <span class="n">ObjectRefGenerator</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;wait() expected a list of ray.ObjectRef or &quot;</span>
                <span class="s2">&quot;ray.ObjectRefGenerator, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;got list containing </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ray_waitable</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="c1"># TODO(swang): Check main thread.</span>
    <span class="k">with</span> <span class="n">profiling</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="s2">&quot;ray.wait&quot;</span><span class="p">):</span>
        <span class="c1"># TODO(rkn): This is a temporary workaround for</span>
        <span class="c1"># https://github.com/ray-project/ray/issues/997. However, it should be</span>
        <span class="c1"># fixed in Arrow instead of here.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ray_waitables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ray_waitables</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ray_waitables</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wait requires a list of unique ray_waitables.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_returns</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid number of objects to return </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">num_returns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_returns</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ray_waitables</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;num_returns cannot be greater than the number &quot;</span>
                <span class="s2">&quot;of ray_waitables provided to ray.wait.&quot;</span>
            <span class="p">)</span>

        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
        <span class="n">timeout_milliseconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">ready_ids</span><span class="p">,</span> <span class="n">remaining_ids</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span>
            <span class="n">ray_waitables</span><span class="p">,</span>
            <span class="n">num_returns</span><span class="p">,</span>
            <span class="n">timeout_milliseconds</span><span class="p">,</span>
            <span class="n">fetch_local</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ready_ids</span><span class="p">,</span> <span class="n">remaining_ids</span></div>



<div class="viewcode-block" id="get_actor">
<a class="viewcode-back" href="../../../ray.html#ray.get_actor">[docs]</a>
<span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_actor</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ray.actor.ActorHandle&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a handle to a named actor.</span>

<span class="sd">    Gets a handle to an actor with the given name. The actor must</span>
<span class="sd">    have been created with Actor.options(name=&quot;name&quot;).remote(). This</span>
<span class="sd">    works for both detached &amp; non-detached actors.</span>

<span class="sd">    This method is a sync call and it&#39;ll timeout after 60s. This can be modified</span>
<span class="sd">    by setting OS env RAY_gcs_server_request_timeout_seconds before starting</span>
<span class="sd">    the cluster.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the actor.</span>
<span class="sd">        namespace: The namespace of the actor, or None to specify the current</span>
<span class="sd">            namespace.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ActorHandle to the actor.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: if the named actor does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please supply a non-empty value to get_actor&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">validate_namespace</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>

    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">get_named_actor_handle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namespace</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="kill">
<a class="viewcode-back" href="../../../ray.html#ray.kill">[docs]</a>
<span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">kill</span><span class="p">(</span><span class="n">actor</span><span class="p">:</span> <span class="s2">&quot;ray.actor.ActorHandle&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">no_restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Kill an actor forcefully.</span>

<span class="sd">    This will interrupt any running tasks on the actor, causing them to fail</span>
<span class="sd">    immediately. ``atexit`` handlers installed in the actor will not be run.</span>

<span class="sd">    If you want to kill the actor but let pending tasks finish,</span>
<span class="sd">    you can call ``actor.__ray_terminate__.remote()`` instead to queue a</span>
<span class="sd">    termination task. Any ``atexit`` handlers installed in the actor *will*</span>
<span class="sd">    be run in this case.</span>

<span class="sd">    If the actor is a detached actor, subsequent calls to get its handle via</span>
<span class="sd">    ray.get_actor will fail.</span>

<span class="sd">    Args:</span>
<span class="sd">        actor: Handle to the actor to kill.</span>
<span class="sd">        no_restart: Whether or not this actor should be restarted if</span>
<span class="sd">            it&#39;s a restartable actor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ActorHandle</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;ray.kill() only supported for actors. For tasks, try ray.cancel(). &quot;</span>
            <span class="s2">&quot;Got: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">actor</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">kill_actor</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">_ray_actor_id</span><span class="p">,</span> <span class="n">no_restart</span><span class="p">)</span></div>



<div class="viewcode-block" id="cancel">
<a class="viewcode-back" href="../../../ray.html#ray.cancel">[docs]</a>
<span class="nd">@PublicAPI</span>
<span class="nd">@client_mode_hook</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span>
    <span class="n">ray_waitable</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;ObjectRef[R]&quot;</span><span class="p">,</span> <span class="s2">&quot;ObjectRefGenerator[R]&quot;</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cancels a task.</span>

<span class="sd">    Cancel API has a different behavior depending on if it is a remote function</span>
<span class="sd">    (Task) or a remote Actor method (Actor Task).</span>

<span class="sd">    Task:</span>
<span class="sd">        If the specified Task is pending execution, it is cancelled and not</span>
<span class="sd">        executed. If the Task is currently executing, the behavior depends</span>
<span class="sd">        on the `force` flag. When `force=False`, a KeyboardInterrupt is</span>
<span class="sd">        raised in Python and when `force=True`, the executing Task</span>
<span class="sd">        immediately exits. If the Task is already finished, nothing happens.</span>

<span class="sd">        Cancelled Tasks aren&#39;t retried. `max_task_retries` aren&#39;t respected.</span>

<span class="sd">        Calling ray.get on a cancelled Task raises a TaskCancelledError</span>
<span class="sd">        if the Task has been scheduled or interrupted.</span>
<span class="sd">        It raises a WorkerCrashedError if `force=True`.</span>

<span class="sd">        If `recursive=True`, all the child Tasks and Actor Tasks</span>
<span class="sd">        are cancelled. If `force=True` and `recursive=True`, `force=True`</span>
<span class="sd">        is ignored for child Actor Tasks.</span>

<span class="sd">    Actor Task:</span>
<span class="sd">        If the specified Task is pending execution, it is cancelled and not</span>
<span class="sd">        executed. If the Task is currently executing, the behavior depends</span>
<span class="sd">        on the execution model of an Actor. If it is a regular Actor</span>
<span class="sd">        or a threaded Actor, the execution isn&#39;t cancelled.</span>
<span class="sd">        Actor Tasks cannot be interrupted because Actors have</span>
<span class="sd">        states. If it is an async Actor, Ray cancels a `asyncio.Task`.</span>
<span class="sd">        The semantic of cancellation is equivalent to asyncio&#39;s cancellation.</span>
<span class="sd">        https://docs.python.org/3/library/asyncio-task.html#task-cancellation</span>
<span class="sd">        If the Task has finished, nothing happens.</span>

<span class="sd">        Only `force=False` is allowed for an Actor Task. Otherwise, it raises</span>
<span class="sd">        `ValueError`. Use `ray.kill(actor)` instead to kill an Actor.</span>

<span class="sd">        Cancelled Tasks aren&#39;t retried. `max_task_retries` aren&#39;t respected.</span>

<span class="sd">        Calling ray.get on a cancelled Task raises a TaskCancelledError</span>
<span class="sd">        if the Task has been scheduled or interrupted. Also note that</span>
<span class="sd">        only async actor tasks can be interrupted.</span>

<span class="sd">        If `recursive=True`, all the child Tasks and actor Tasks</span>
<span class="sd">        are cancelled.</span>

<span class="sd">    Args:</span>
<span class="sd">        ray_waitable: :class:`~ObjectRef` and</span>
<span class="sd">            :class:`~ObjectRefGenerator`</span>
<span class="sd">            returned by the task that should be canceled.</span>
<span class="sd">        force: Whether to force-kill a running task by killing</span>
<span class="sd">            the worker that is running the task.</span>
<span class="sd">        recursive: Whether to try to cancel tasks submitted by the</span>
<span class="sd">            task specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">_private</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">global_worker</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">check_connected</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ray_waitable</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">_raylet</span><span class="o">.</span><span class="n">ObjectRefGenerator</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ray_waitable</span><span class="p">,</span> <span class="s2">&quot;_generator_ref&quot;</span><span class="p">)</span>
        <span class="n">ray_waitable</span> <span class="o">=</span> <span class="n">ray_waitable</span><span class="o">.</span><span class="n">_generator_ref</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ray_waitable</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;ray.cancel() only supported for object refs. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;For actors, try ray.kill(). Got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ray_waitable</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">worker</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">cancel_task</span><span class="p">(</span><span class="n">ray_waitable</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">recursive</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_mode</span><span class="p">(</span><span class="n">worker</span><span class="o">=</span><span class="n">global_worker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is a wrapper around worker.mode.</span>

<span class="sd">    We use this wrapper so that in the remote decorator, we can call _mode()</span>
<span class="sd">    instead of worker.mode. The difference is that when we attempt to</span>
<span class="sd">    serialize remote functions, we don&#39;t attempt to serialize the worker</span>
<span class="sd">    object, which cannot be serialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">worker</span><span class="o">.</span><span class="n">mode</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_make_remote</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">function_or_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">:</span>
        <span class="n">function_or_class</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="s2">&quot;global&quot;</span>

    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_cython</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">):</span>
        <span class="n">ray_option_utils</span><span class="o">.</span><span class="n">validate_task_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">in_options</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">remote_function</span><span class="o">.</span><span class="n">RemoteFunction</span><span class="p">(</span>
            <span class="n">Language</span><span class="o">.</span><span class="n">PYTHON</span><span class="p">,</span>
            <span class="n">function_or_class</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">options</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">):</span>
        <span class="n">ray_option_utils</span><span class="o">.</span><span class="n">validate_actor_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">in_options</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ray</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">_make_actor</span><span class="p">(</span><span class="n">function_or_class</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s2">&quot;The @ray.remote decorator must be applied to either a function or a class.&quot;</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RemoteDecorator</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RemoteFunctionNoArgs</span><span class="p">[</span><span class="n">R</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction0</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction1</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction2</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction3</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction4</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction5</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction6</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction7</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction8</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">,</span> <span class="n">T9</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction9</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">,</span> <span class="n">T9</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="c1"># Pass on typing actors for now. The following makes it so no type errors</span>
    <span class="c1"># are generated for actors.</span>
    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__t</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span><span class="n">__t</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ActorClass</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span><span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RemoteFunctionNoArgs</span><span class="p">[</span><span class="n">R</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span><span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction0</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span><span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction1</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span><span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">],</span> <span class="n">R</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction2</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
    <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction3</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
    <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction4</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
    <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction5</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
    <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction6</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
    <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction7</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
    <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction8</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
    <span class="n">__function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">,</span> <span class="n">T9</span><span class="p">],</span> <span class="n">R</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteFunction9</span><span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">T5</span><span class="p">,</span> <span class="n">T6</span><span class="p">,</span> <span class="n">T7</span><span class="p">,</span> <span class="n">T8</span><span class="p">,</span> <span class="n">T9</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="c1"># Passing options</span>
<span class="nd">@overload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">num_returns</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;streaming&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">num_cpus</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">num_gpus</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">resources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">accelerator_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">memory</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">max_calls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">max_restarts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">max_task_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">runtime_env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">retry_exceptions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">scheduling_strategy</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="kc">None</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;DEFAULT&quot;</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;SPREAD&quot;</span><span class="p">],</span> <span class="n">PlacementGroupSchedulingStrategy</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">label_selector</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteDecorator</span><span class="p">:</span>
    <span class="o">...</span>


<div class="viewcode-block" id="remote">
<a class="viewcode-back" href="../../../ray.html#ray.remote">[docs]</a>
<span class="nd">@PublicAPI</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remote</span><span class="p">(</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">remote_function</span><span class="o">.</span><span class="n">RemoteFunction</span><span class="p">,</span> <span class="n">ray</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ActorClass</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Defines a remote function or an actor class.</span>

<span class="sd">    This function can be used as a decorator with no arguments</span>
<span class="sd">    to define a remote function or actor as follows:</span>

<span class="sd">    .. testcode::</span>

<span class="sd">        import ray</span>

<span class="sd">        @ray.remote</span>
<span class="sd">        def f(a, b, c):</span>
<span class="sd">            return a + b + c</span>

<span class="sd">        object_ref = f.remote(1, 2, 3)</span>
<span class="sd">        result = ray.get(object_ref)</span>
<span class="sd">        assert result == (1 + 2 + 3)</span>

<span class="sd">        @ray.remote</span>
<span class="sd">        class Foo:</span>
<span class="sd">            def __init__(self, arg):</span>
<span class="sd">                self.x = arg</span>

<span class="sd">            def method(self, a):</span>
<span class="sd">                return self.x + a</span>

<span class="sd">        actor_handle = Foo.remote(123)</span>
<span class="sd">        object_ref = actor_handle.method.remote(321)</span>
<span class="sd">        result = ray.get(object_ref)</span>
<span class="sd">        assert result == (123 + 321)</span>

<span class="sd">    Equivalently, use a function call to create a remote function or actor.</span>

<span class="sd">    .. testcode::</span>

<span class="sd">        def g(a, b, c):</span>
<span class="sd">            return a + b + c</span>

<span class="sd">        remote_g = ray.remote(g)</span>
<span class="sd">        object_ref = remote_g.remote(1, 2, 3)</span>
<span class="sd">        assert ray.get(object_ref) == (1 + 2 + 3)</span>

<span class="sd">        class Bar:</span>
<span class="sd">            def __init__(self, arg):</span>
<span class="sd">                self.x = arg</span>

<span class="sd">            def method(self, a):</span>
<span class="sd">                return self.x + a</span>

<span class="sd">        RemoteBar = ray.remote(Bar)</span>
<span class="sd">        actor_handle = RemoteBar.remote(123)</span>
<span class="sd">        object_ref = actor_handle.method.remote(321)</span>
<span class="sd">        result = ray.get(object_ref)</span>
<span class="sd">        assert result == (123 + 321)</span>


<span class="sd">    It can also be used with specific keyword arguments as follows:</span>

<span class="sd">    .. testcode::</span>

<span class="sd">        @ray.remote(num_gpus=1, max_calls=1, num_returns=2)</span>
<span class="sd">        def f():</span>
<span class="sd">            return 1, 2</span>

<span class="sd">        @ray.remote(num_cpus=2, resources={&quot;CustomResource&quot;: 1})</span>
<span class="sd">        class Foo:</span>
<span class="sd">            def method(self):</span>
<span class="sd">                return 1</span>

<span class="sd">    Remote task and actor objects returned by @ray.remote can also be</span>
<span class="sd">    dynamically modified with the same arguments as above using</span>
<span class="sd">    ``.options()`` as follows:</span>

<span class="sd">    .. testcode::</span>
<span class="sd">        :hide:</span>

<span class="sd">        ray.shutdown()</span>

<span class="sd">        ray.init(num_cpus=5, num_gpus=5)</span>

<span class="sd">    .. testcode::</span>

<span class="sd">        @ray.remote(num_gpus=1, max_calls=1, num_returns=2)</span>
<span class="sd">        def f():</span>
<span class="sd">            return 1, 2</span>

<span class="sd">        f_with_2_gpus = f.options(num_gpus=2)</span>
<span class="sd">        object_refs = f_with_2_gpus.remote()</span>
<span class="sd">        assert ray.get(object_refs) == [1, 2]</span>

<span class="sd">        @ray.remote(num_cpus=2, resources={&quot;CustomResource&quot;: 1})</span>
<span class="sd">        class Foo:</span>
<span class="sd">            def method(self):</span>
<span class="sd">                return 1</span>

<span class="sd">        Foo_with_no_resources = Foo.options(num_cpus=1, resources=None)</span>
<span class="sd">        foo_actor = Foo_with_no_resources.remote()</span>
<span class="sd">        assert ray.get(foo_actor.method.remote()) == 1</span>


<span class="sd">    A remote actor will be terminated when all actor handle to it</span>
<span class="sd">    in Python is deleted, which will cause them to complete any outstanding</span>
<span class="sd">    work and then shut down. If you only have 1 reference to an actor handle,</span>
<span class="sd">    calling ``del actor`` *could* trigger actor deletion. Note that your program</span>
<span class="sd">    may have multiple references to the same ActorHandle, and actor termination</span>
<span class="sd">    will not occur until the reference count goes to 0. See the Python</span>
<span class="sd">    documentation for more context about object deletion.</span>
<span class="sd">    https://docs.python.org/3.9/reference/datamodel.html#object.__del__</span>

<span class="sd">    If you want to kill actors immediately, you can also call ``ray.kill(actor)``.</span>

<span class="sd">    .. tip::</span>
<span class="sd">        Avoid repeatedly passing in large arguments to remote task or method calls.</span>

<span class="sd">        Instead, use ray.put to create a copy of the object in the object store.</span>

<span class="sd">        See :ref:`more info here &lt;ray-pass-large-arg-by-value&gt;`.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_returns: This is only for *remote functions*. It specifies</span>
<span class="sd">            the number of object refs returned by the remote function</span>
<span class="sd">            invocation. The default value is 1.</span>
<span class="sd">            Pass &quot;dynamic&quot; to allow the task to decide how many</span>
<span class="sd">            return values to return during execution, and the caller will</span>
<span class="sd">            receive an ObjectRef[DynamicObjectRefGenerator].</span>
<span class="sd">            See :ref:`dynamic generators &lt;dynamic-generators&gt;` for more details.</span>
<span class="sd">        num_cpus: The quantity of CPU resources to reserve</span>
<span class="sd">            for this task or for the lifetime of the actor.</span>
<span class="sd">            By default, tasks use 1 CPU resource and actors use 1 CPU</span>
<span class="sd">            for scheduling and 0 CPU for running</span>
<span class="sd">            (This means, by default, actors cannot get scheduled on a zero-cpu node,</span>
<span class="sd">            but an infinite number of them can run on any non-zero cpu node.</span>
<span class="sd">            The default value for actors was chosen for historical reasons.</span>
<span class="sd">            It&#39;s recommended to always explicitly set num_cpus for actors</span>
<span class="sd">            to avoid any surprises.</span>
<span class="sd">            If resources are specified explicitly,</span>
<span class="sd">            they are required for both scheduling and running.)</span>
<span class="sd">            See :ref:`specifying resource requirements &lt;resource-requirements&gt;`</span>
<span class="sd">            for more details.</span>
<span class="sd">        num_gpus: The quantity of GPU resources to reserve</span>
<span class="sd">            for this task or for the lifetime of the actor.</span>
<span class="sd">            The default value is 0.</span>
<span class="sd">            See :ref:`Ray GPU support &lt;gpu-support&gt;` for more details.</span>
<span class="sd">        resources (Dict[str, float]): The quantity of various</span>
<span class="sd">            :ref:`custom resources &lt;custom-resources&gt;`</span>
<span class="sd">            to reserve for this task or for the lifetime of the actor.</span>
<span class="sd">            This is a dictionary mapping strings (resource names) to floats.</span>
<span class="sd">            By default it is empty.</span>
<span class="sd">        label_selector (Dict[str, str]): [Experimental] If specified, the labels required for the node on</span>
<span class="sd">                which this actor can be scheduled on. The label selector consist of key-value pairs,</span>
<span class="sd">                where the keys are label names and the value are expressions consisting of an operator</span>
<span class="sd">                with label values or just a value to indicate equality.</span>
<span class="sd">        accelerator_type: If specified, requires that the task or actor run</span>
<span class="sd">            on a node with the specified type of accelerator.</span>
<span class="sd">            See :ref:`accelerator types &lt;accelerator_types&gt;`.</span>
<span class="sd">        memory: The heap memory request in bytes for this task/actor,</span>
<span class="sd">            rounded down to the nearest integer.</span>
<span class="sd">        max_calls: Only for *remote functions*. This specifies the</span>
<span class="sd">            maximum number of times that a given worker can execute</span>
<span class="sd">            the given remote function before it must exit</span>
<span class="sd">            (this can be used to address :ref:`memory leaks &lt;gpu-leak&gt;` in third-party</span>
<span class="sd">            libraries or to reclaim resources that cannot easily be</span>
<span class="sd">            released, e.g., GPU memory that was acquired by TensorFlow).</span>
<span class="sd">            By default this is infinite for CPU tasks and 1 for GPU tasks</span>
<span class="sd">            (to force GPU tasks to release resources after finishing).</span>
<span class="sd">        max_restarts: Only for *actors*. This specifies the maximum</span>
<span class="sd">            number of times that the actor should be restarted when it dies</span>
<span class="sd">            unexpectedly. The minimum valid value is 0 (default),</span>
<span class="sd">            which indicates that the actor doesn&#39;t need to be restarted.</span>
<span class="sd">            A value of -1 indicates that an actor should be restarted</span>
<span class="sd">            indefinitely.</span>
<span class="sd">            See :ref:`actor fault tolerance &lt;fault-tolerance-actors&gt;` for more details.</span>
<span class="sd">        max_task_retries: Only for *actors*. How many times to</span>
<span class="sd">            retry an actor task if the task fails due to a system error,</span>
<span class="sd">            e.g., the actor has died. If set to -1, the system will</span>
<span class="sd">            retry the failed task until the task succeeds, or the actor</span>
<span class="sd">            has reached its max_restarts limit. If set to `n &gt; 0`, the</span>
<span class="sd">            system will retry the failed task up to n times, after which the</span>
<span class="sd">            task will throw a `RayActorError` exception upon :obj:`ray.get`.</span>
<span class="sd">            Note that Python exceptions are not considered system errors</span>
<span class="sd">            and will not trigger retries.</span>
<span class="sd">            The default value is 0.</span>
<span class="sd">            See :ref:`actor fault tolerance &lt;fault-tolerance-actors&gt;` for more details.</span>
<span class="sd">        max_retries: Only for *remote functions*. This specifies</span>
<span class="sd">            the maximum number of times that the remote function</span>
<span class="sd">            should be rerun when the worker process executing it</span>
<span class="sd">            crashes unexpectedly. The minimum valid value is 0,</span>
<span class="sd">            the default value is 3, and a value of -1 indicates</span>
<span class="sd">            infinite retries.</span>
<span class="sd">            See :ref:`task fault tolerance &lt;fault-tolerance-tasks&gt;` for more details.</span>
<span class="sd">        runtime_env (Dict[str, Any]): Specifies the runtime environment for</span>
<span class="sd">            this actor or task and its children. See</span>
<span class="sd">            :ref:`runtime-environments` for detailed documentation.</span>
<span class="sd">        retry_exceptions: Only for *remote functions*. This specifies whether</span>
<span class="sd">            application-level errors should be retried up to max_retries times.</span>
<span class="sd">            This can be a boolean or a list of exceptions that should be retried.</span>
<span class="sd">            See :ref:`task fault tolerance &lt;fault-tolerance-tasks&gt;` for more details.</span>
<span class="sd">        scheduling_strategy: Strategy about how to</span>
<span class="sd">            schedule a remote function or actor. Possible values are</span>
<span class="sd">            None: ray will figure out the scheduling strategy to use, it</span>
<span class="sd">            will either be the PlacementGroupSchedulingStrategy using parent&#39;s</span>
<span class="sd">            placement group if parent has one and has</span>
<span class="sd">            placement_group_capture_child_tasks set to true,</span>
<span class="sd">            or &quot;DEFAULT&quot;;</span>
<span class="sd">            &quot;DEFAULT&quot;: default hybrid scheduling;</span>
<span class="sd">            &quot;SPREAD&quot;: best effort spread scheduling;</span>
<span class="sd">            `PlacementGroupSchedulingStrategy`:</span>
<span class="sd">            placement group based scheduling;</span>
<span class="sd">            `NodeAffinitySchedulingStrategy`:</span>
<span class="sd">            node id based affinity scheduling.</span>
<span class="sd">            See :ref:`Ray scheduling strategies &lt;ray-scheduling-strategies&gt;`</span>
<span class="sd">            for more details.</span>
<span class="sd">        _metadata: Extended options for Ray libraries. For example,</span>
<span class="sd">            _metadata={&quot;workflows.io/options&quot;: &lt;workflow options&gt;} for Ray workflows.</span>
<span class="sd">        _labels: The key-value labels of a task or actor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># &quot;callable&quot; returns true for both function and class.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># This is the case where the decorator is just @ray.remote.</span>
        <span class="c1"># &quot;args[0]&quot; is the class or function under the decorator.</span>
        <span class="k">return</span> <span class="n">_make_remote</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{})</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ray_option_utils</span><span class="o">.</span><span class="n">remote_args_error_string</span>
    <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_make_remote</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Andres Bermeo Marinelli
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>